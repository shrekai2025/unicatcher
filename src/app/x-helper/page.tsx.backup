'use client';

import { useState, useEffect } from 'react';
import { DashboardLayout } from '~/components/dashboard-layout';

interface TweetInfo {
  id: string;
  content: string;
  userNickname: string;
  userUsername: string;
  profileImageUrl: string | null;
  tweetUrl: string;
  publishedAtFormatted: string;

  // ç¿»è¯‘ç›¸å…³
  translatedContent: string | null;
  isTranslated: boolean;
  originalLanguage: string | null;

  // ç»Ÿè®¡æ•°æ®
  replyCount: number;
  retweetCount: number;
  likeCount: number;
  viewCount: number;

  // è¯„è®ºç›¸å…³
  commentCount: number;
  recentComments: any[];
}

interface AIConfig {
  apiKey: string;
  provider: 'openai' | 'openai-badger' | 'zhipu';
  model: string;
  baseURL?: string;
}

interface ProcessTask {
  id: string;
  tweetUrl: string;
  tweetId: string;
  status: 'processing' | 'completed' | 'failed';
  startTime: string;

  // ç¿»è¯‘çŠ¶æ€
  translationStatus: 'pending' | 'processing' | 'completed' | 'failed';
  translationResult?: any;

  // æ¨ç‰¹è¯„è®ºçˆ¬å–çŠ¶æ€ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰
  crawlCommentsStatus: 'pending' | 'processing' | 'completed' | 'failed';
  crawlCommentsResult?: any;

  // AIç”Ÿæˆè¯„è®ºçŠ¶æ€ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
  generateCommentsStatus: 'pending' | 'processing' | 'completed' | 'failed';
  generateCommentsResult?: any;

  tweetInfo?: TweetInfo;
  error?: string;
}

export default function XHelperPage() {
  // å®¢æˆ·ç«¯æŒ‚è½½çŠ¶æ€
  const [mounted, setMounted] = useState(false);

  // åŸºæœ¬çŠ¶æ€
  const [tweetUrl, setTweetUrl] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [currentTask, setCurrentTask] = useState<ProcessTask | null>(null);

  // AIé…ç½®çŠ¶æ€
  const [showAIConfig, setShowAIConfig] = useState(false);
  const [translationAIConfig, setTranslationAIConfig] = useState<AIConfig>({
    apiKey: '',
    provider: 'zhipu',
    model: 'glm-4.5-flash'
  });

  const [commentAIConfig, setCommentAIConfig] = useState<AIConfig>({
    apiKey: '',
    provider: 'zhipu',
    model: 'glm-4.5-flash'
  });

  // ä»»åŠ¡å†å²
  const [taskHistory, setTaskHistory] = useState<ProcessTask[]>([]);

  // æ¢å¤çŠ¶æ€æç¤º
  const [recoveryStatus, setRecoveryStatus] = useState<string | null>(null);

  // å®¢æˆ·ç«¯æŒ‚è½½ååŠ è½½localStorageæ•°æ®
  useEffect(() => {
    setMounted(true);

    // åŠ è½½ç¿»è¯‘AIé…ç½®
    const savedTranslationConfig = localStorage.getItem('x-helper-translation-ai-config');
    if (savedTranslationConfig) {
      try {
        setTranslationAIConfig(JSON.parse(savedTranslationConfig));
      } catch (e) {
        console.warn('ç¿»è¯‘AIé…ç½®è§£æå¤±è´¥:', e);
      }
    }

    // åŠ è½½è¯„è®ºAIé…ç½®
    const savedCommentConfig = localStorage.getItem('x-helper-comment-ai-config');
    if (savedCommentConfig) {
      try {
        setCommentAIConfig(JSON.parse(savedCommentConfig));
      } catch (e) {
        console.warn('è¯„è®ºAIé…ç½®è§£æå¤±è´¥:', e);
      }
    }

    // åŠ è½½ä»»åŠ¡å†å²
    const savedTaskHistory = localStorage.getItem('x-helper-task-history');
    if (savedTaskHistory) {
      try {
        const tasks = JSON.parse(savedTaskHistory);
        // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡éœ€è¦æ¢å¤
        checkAndRecoverUnfinishedTasks(tasks);
        setTaskHistory(tasks);
      } catch (e) {
        console.warn('ä»»åŠ¡å†å²è§£æå¤±è´¥:', e);
      }
    }
  }, []);

  // ä¿å­˜é…ç½®åˆ°localStorage
  const saveAIConfigs = () => {
    if (mounted) {
      localStorage.setItem('x-helper-translation-ai-config', JSON.stringify(translationAIConfig));
      localStorage.setItem('x-helper-comment-ai-config', JSON.stringify(commentAIConfig));
    }
    setShowAIConfig(false);
  };

  // ä¿å­˜ä»»åŠ¡å†å²åˆ°localStorage
  useEffect(() => {
    if (mounted) {
      localStorage.setItem('x-helper-task-history', JSON.stringify(taskHistory));
    }
  }, [taskHistory, mounted]);

  // å¤„ç†æ¨æ–‡
  const handleProcessTweet = async () => {
    console.log('[X Helper] å¼€å§‹å¤„ç†æ¨æ–‡:', tweetUrl);

    if (!tweetUrl.trim()) {
      alert('è¯·è¾“å…¥æ¨æ–‡URL');
      return;
    }

    if (!translationAIConfig.apiKey || !commentAIConfig.apiKey) {
      console.log('[X Helper] AIé…ç½®æ£€æŸ¥å¤±è´¥ - ç¿»è¯‘é…ç½®:', !!translationAIConfig.apiKey, 'è¯„è®ºé…ç½®:', !!commentAIConfig.apiKey);
      alert('è¯·å…ˆé…ç½®AIæœåŠ¡');
      setShowAIConfig(true);
      return;
    }

    console.log('[X Helper] AIé…ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹å¤„ç†');
    setIsProcessing(true);

    try {
      // ç¬¬1æ­¥ï¼šè§£æURL
      console.log('[X Helper] æ­¥éª¤1: è§£æURL -', tweetUrl);
      const parseResponse = await fetch('/api/tweet-processor/parse-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: tweetUrl })
      });

      console.log('[X Helper] URLè§£æå“åº”çŠ¶æ€:', parseResponse.status);
      const parseResult = await parseResponse.json();
      console.log('[X Helper] URLè§£æç»“æœ:', parseResult);

      if (!parseResult.success) {
        throw new Error(parseResult.error?.message || 'URLè§£æå¤±è´¥');
      }

      const tweetId = parseResult.data.tweetId;
      console.log('[X Helper] æå–çš„æ¨æ–‡ID:', tweetId);

      // åˆ›å»ºä»»åŠ¡è®°å½•
      const newTask: ProcessTask = {
        id: Date.now().toString(),
        tweetUrl: tweetUrl,
        tweetId: tweetId,
        status: 'processing',
        startTime: new Date().toLocaleString('zh-CN'),
        translationStatus: 'pending',
        crawlCommentsStatus: 'pending',
        generateCommentsStatus: 'pending'
      };

      setCurrentTask(newTask);
      setTaskHistory(prev => [newTask, ...prev.slice(0, 9)]); // ä¿ç•™æœ€è¿‘10æ¡

      // ç¬¬2æ­¥ï¼šè·å–æˆ–çˆ¬å–æ¨æ–‡ä¿¡æ¯
      console.log('[X Helper] æ­¥éª¤2: è·å–æ¨æ–‡ä¿¡æ¯ -', tweetId);
      let tweetInfoResult = await fetchTweetInfo(tweetId);

      // å¦‚æœæ¨æ–‡ä¸åœ¨æ•°æ®åº“ä¸­ï¼Œå°è¯•çˆ¬å–
      if (!tweetInfoResult.success && tweetInfoResult.error?.code === 'NOT_FOUND') {
        console.log('[X Helper] æ¨æ–‡ä¸åœ¨æ•°æ®åº“ä¸­ï¼Œå°è¯•çˆ¬å–æ¨æ–‡æ•°æ®');

        // å°è¯•çˆ¬å–æ¨æ–‡æ•°æ®
        const updateResult = await crawlTweetData(tweetId);
        if (updateResult.success) {
          // ç­‰å¾…çˆ¬å–å®Œæˆåå†æ¬¡è·å–
          const pollResult = await pollTaskStatus(updateResult.data.taskId);
          if (pollResult.success) {
            console.log('[X Helper] æ¨æ–‡çˆ¬å–æˆåŠŸï¼Œå†æ¬¡è·å–æ¨æ–‡ä¿¡æ¯');
            tweetInfoResult = await fetchTweetInfo(tweetId);
          }
        }
      }

      if (tweetInfoResult.success) {
        console.log('[X Helper] æ¨æ–‡ä¿¡æ¯è·å–æˆåŠŸ');
        newTask.tweetInfo = tweetInfoResult.data;
        setCurrentTask({ ...newTask });
      } else {
        console.log('[X Helper] æ¨æ–‡ä¿¡æ¯è·å–å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ');
        // å¦‚æœä¾ç„¶æ²¡æœ‰æ¨æ–‡å†…å®¹ï¼Œæˆ‘ä»¬å°†æ— æ³•è¿›è¡Œç¿»è¯‘ï¼Œä½†ä»ç„¶å¯ä»¥å°è¯•è¯„è®ºçˆ¬å–
      }

      // ç¬¬3æ­¥ï¼šå¹¶è¡Œæ‰§è¡Œç¿»è¯‘å’Œè·å–è¯„è®º
      console.log('[X Helper] æ­¥éª¤3: å¼€å§‹å¹¶è¡Œå¤„ç†ç¿»è¯‘å’Œè¯„è®ºè·å–');
      const promises: Promise<any>[] = [];

      // ç¿»è¯‘ä»»åŠ¡
      console.log('[X Helper] æ­¥éª¤3a: å¼€å§‹ç¿»è¯‘å¤„ç†');
      console.log('[X Helper] ç¿»è¯‘å†…å®¹:', newTask.tweetInfo?.content || '');
      console.log('[X Helper] ç¿»è¯‘AIé…ç½®:', { provider: translationAIConfig.provider, model: translationAIConfig.model, hasApiKey: !!translationAIConfig.apiKey });
      newTask.translationStatus = 'processing';
      setCurrentTask({ ...newTask });

      promises.push(
        fetch('/api/tweet-processor/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: newTask.tweetInfo?.content || '',
            aiConfig: translationAIConfig
          })
        }).then(res => {
          console.log('[X Helper] ç¿»è¯‘APIå“åº”çŠ¶æ€:', res.status);
          return res.json();
        }).then(result => {
          console.log('[X Helper] ç¿»è¯‘APIç»“æœ:', result);
          if (result.success) {
            console.log('[X Helper] ç¿»è¯‘æˆåŠŸ:', result.data?.translatedContent?.substring(0, 100) + '...');
            newTask.translationStatus = 'completed';
            newTask.translationResult = result.data;
          } else {
            console.log('[X Helper] ç¿»è¯‘å¤±è´¥:', result.error?.message);
            newTask.translationStatus = 'failed';
            newTask.error = result.error?.message;
          }
          return { type: 'translation', result };
        }).catch(error => {
          console.error('[X Helper] ç¿»è¯‘è¯·æ±‚å¼‚å¸¸:', error);
          newTask.translationStatus = 'failed';
          newTask.error = error.message;
          return { type: 'translation', error: error.message };
        })
      );

      // è¯„è®ºè·å–ä»»åŠ¡
      console.log('[X Helper] æ­¥éª¤3b: å¼€å§‹è¯„è®ºçˆ¬å–å¤„ç†');
      console.log('[X Helper] çˆ¬å–æ¨æ–‡ID:', tweetId);
      newTask.commentsStatus = 'processing';
      setCurrentTask({ ...newTask });

      promises.push(
        fetch('/api/tweet-processor/crawl-comments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
'x-api-key': 'unicatcher-api-key-2024'
          },
          body: JSON.stringify({
            tweetId: tweetId,
            incremental: false,
            maxScrolls: 10
          })
        }).then(res => {
          console.log('[X Helper] è¯„è®ºçˆ¬å–APIå“åº”çŠ¶æ€:', res.status);
          return res.json();
        }).then(result => {
          console.log('[X Helper] è¯„è®ºçˆ¬å–APIç»“æœ:', result);
          if (result.success) {
            console.log('[X Helper] è¯„è®ºçˆ¬å–ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID:', result.data.taskId);
            // è½®è¯¢ä»»åŠ¡çŠ¶æ€
            return pollTaskStatus(result.data.taskId).then(taskResult => {
              console.log('[X Helper] è¯„è®ºçˆ¬å–ä»»åŠ¡å®Œæˆï¼Œç»“æœ:', taskResult);
              if (taskResult.success) {
                console.log('[X Helper] è¯„è®ºçˆ¬å–æˆåŠŸï¼Œè·å–åˆ°è¯„è®ºæ•°:', taskResult.data?.totalComments || 0);
                newTask.commentsStatus = 'completed';
                newTask.commentsResult = taskResult.data;

                // ç”Ÿæˆè¯„è®º
                console.log('[X Helper] å¼€å§‹ç”Ÿæˆè¯„è®º');
                return generateComments(tweetId, newTask.tweetInfo?.content || '');
              } else {
                console.log('[X Helper] è¯„è®ºçˆ¬å–ä»»åŠ¡å¤±è´¥:', taskResult.error?.message);
                newTask.commentsStatus = 'failed';
                newTask.error = taskResult.error?.message;
                return { type: 'comments', result: taskResult };
              }
            });
          } else {
            console.log('[X Helper] è¯„è®ºçˆ¬å–APIè°ƒç”¨å¤±è´¥:', result.error?.message);
            newTask.commentsStatus = 'failed';
            newTask.error = result.error?.message;
            return { type: 'comments', result };
          }
        }).catch(error => {
          console.error('[X Helper] è¯„è®ºçˆ¬å–è¯·æ±‚å¼‚å¸¸:', error);
          newTask.commentsStatus = 'failed';
          newTask.error = error.message;
          return { type: 'comments', error: error.message };
        })
      );

      // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
      console.log('[X Helper] æ­¥éª¤4: ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ');
      const results = await Promise.allSettled(promises);
      console.log('[X Helper] æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œç»“æœ:', results);

      // æ›´æ–°æœ€ç»ˆçŠ¶æ€
      newTask.status = 'completed';
      console.log('[X Helper] ä»»åŠ¡æœ€ç»ˆçŠ¶æ€:', {
        id: newTask.id,
        tweetId: newTask.tweetId,
        translationStatus: newTask.translationStatus,
        commentsStatus: newTask.commentsStatus,
        error: newTask.error
      });
      setCurrentTask({ ...newTask });
      setTaskHistory(prev => [newTask, ...prev.slice(1)]);

    } catch (error: any) {
      console.error('[X Helper] æ•´ä½“å¤„ç†å¤±è´¥:', error);
      const failedTask: ProcessTask = {
        id: Date.now().toString(),
        tweetUrl: tweetUrl,
        tweetId: '',
        status: 'failed',
        startTime: new Date().toLocaleString('zh-CN'),
        translationStatus: 'failed',
        commentsStatus: 'failed',
        error: error.message
      };

      console.log('[X Helper] åˆ›å»ºå¤±è´¥ä»»åŠ¡è®°å½•:', failedTask);
      setCurrentTask(failedTask);
      setTaskHistory(prev => [failedTask, ...prev.slice(0, 9)]);
    } finally {
      console.log('[X Helper] å¤„ç†ç»“æŸï¼Œè®¾ç½®isProcessingä¸ºfalse');
      setIsProcessing(false);
    }
  };

  // è½®è¯¢ä»»åŠ¡çŠ¶æ€
  const pollTaskStatus = async (taskId: string): Promise<any> => {
    console.log('[X Helper] å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼Œä»»åŠ¡ID:', taskId);
    let attempts = 0;
    const maxAttempts = 30; // æœ€å¤š30æ¬¡ï¼Œæ€»å…±çº¦1åˆ†é’Ÿ

    while (attempts < maxAttempts) {
      try {
        console.log(`[X Helper] è½®è¯¢å°è¯• ${attempts + 1}/${maxAttempts}`);
        const response = await fetch(`/api/tweet-processor/status/${taskId}`, {
          headers: { 'x-api-key': process.env.NEXT_PUBLIC_API_KEY || 'unicatcher-api-key-demo' }
        });

        console.log('[X Helper] ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å“åº”çŠ¶æ€:', response.status);
        const result = await response.json();
        console.log('[X Helper] ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ç»“æœ:', result);

        if (result.success && result.data.status === 'completed') {
          console.log('[X Helper] ä»»åŠ¡çŠ¶æ€è½®è¯¢å®Œæˆï¼Œä»»åŠ¡æˆåŠŸ');
          return { success: true, data: result.data.result };
        } else if (result.data.status === 'failed') {
          console.log('[X Helper] ä»»åŠ¡çŠ¶æ€è½®è¯¢å®Œæˆï¼Œä»»åŠ¡å¤±è´¥:', result.data.errorMessage);
          return { success: false, error: { message: result.data.errorMessage } };
        }

        console.log(`[X Helper] ä»»åŠ¡çŠ¶æ€: ${result.data.status}ï¼Œç»§ç»­è½®è¯¢`);
        // ç»§ç»­è½®è¯¢
        await new Promise(resolve => setTimeout(resolve, 2000));
        attempts++;
      } catch (error) {
        console.error('[X Helper] è½®è¯¢ä»»åŠ¡çŠ¶æ€å¼‚å¸¸:', error);
        attempts++;
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }

    console.log('[X Helper] ä»»åŠ¡çŠ¶æ€è½®è¯¢è¶…æ—¶');
    return { success: false, error: { message: 'ä»»åŠ¡è¶…æ—¶' } };
  };

  // è·å–æ¨æ–‡ä¿¡æ¯
  const fetchTweetInfo = async (tweetId: string) => {
    try {
      const response = await fetch(`/api/tweet-processor/tweet-info/${tweetId}`);
      console.log('[X Helper] æ¨æ–‡ä¿¡æ¯å“åº”çŠ¶æ€:', response.status);
      const result = await response.json();
      console.log('[X Helper] æ¨æ–‡ä¿¡æ¯ç»“æœ:', result);
      return result;
    } catch (error) {
      console.error('[X Helper] è·å–æ¨æ–‡ä¿¡æ¯å¼‚å¸¸:', error);
      return { success: false, error: { message: 'ç½‘ç»œé”™è¯¯' } };
    }
  };

  // çˆ¬å–æ¨æ–‡æ•°æ®
  const crawlTweetData = async (tweetId: string) => {
    try {
      console.log('[X Helper] å¼€å§‹çˆ¬å–æ¨æ–‡æ•°æ®:', tweetId);
      const response = await fetch('/api/tweet-processor/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': process.env.NEXT_PUBLIC_API_KEY || 'unicatcher-api-key-demo'
        },
        body: JSON.stringify({
          tweetId: tweetId,
          force: false
        })
      });

      console.log('[X Helper] æ¨æ–‡çˆ¬å–APIå“åº”çŠ¶æ€:', response.status);
      const result = await response.json();
      console.log('[X Helper] æ¨æ–‡çˆ¬å–APIç»“æœ:', result);
      return result;
    } catch (error) {
      console.error('[X Helper] çˆ¬å–æ¨æ–‡æ•°æ®å¼‚å¸¸:', error);
      return { success: false, error: { message: 'ç½‘ç»œé”™è¯¯' } };
    }
  };

  // ç”Ÿæˆè¯„è®º
  const generateComments = async (tweetId: string, content: string) => {
    console.log('[X Helper] å¼€å§‹ç”Ÿæˆè¯„è®º');
    console.log('[X Helper] ç”Ÿæˆè¯„è®ºå‚æ•°:', { tweetId, content: content.substring(0, 100) + '...', aiConfig: { provider: commentAIConfig.provider, model: commentAIConfig.model, hasApiKey: !!commentAIConfig.apiKey } });

    try {
      const response = await fetch('/api/tweet-processor/generate-comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tweetId,
          systemPrompt: '',
          includeExistingComments: true,
          commentCount: 3,
          commentLength: 'medium',
          language: 'zh-CN',
          aiConfig: commentAIConfig
        })
      });

      console.log('[X Helper] ç”Ÿæˆè¯„è®ºAPIå“åº”çŠ¶æ€:', response.status);
      const result = await response.json();
      console.log('[X Helper] ç”Ÿæˆè¯„è®ºAPIç»“æœ:', result);

      if (result.success && currentTask) {
        console.log('[X Helper] è¯„è®ºç”ŸæˆæˆåŠŸï¼Œç”Ÿæˆæ•°é‡:', result.data?.comments?.length || 0);
        console.log('[X Helper] è¯„è®ºç”Ÿæˆè¯¦ç»†æ•°æ®:', result.data);
        console.log('[X Helper] è¯„è®ºæ•°ç»„:', result.data?.comments);
        // ä¸ºäº†ä¿æŒå‰ç«¯ä¸€è‡´æ€§ï¼Œå°†commentsé‡å‘½åä¸ºgeneratedComments
        currentTask.generatedCommentsResult = {
          ...result.data,
          generatedComments: result.data?.comments || []
        };
        setCurrentTask({ ...currentTask });
      } else {
        console.log('[X Helper] è¯„è®ºç”Ÿæˆå¤±è´¥:', result.error?.message);
        console.log('[X Helper] å®Œæ•´é”™è¯¯ä¿¡æ¯:', result);
      }

      return result;
    } catch (error) {
      console.error('[X Helper] ç”Ÿæˆè¯„è®ºå¼‚å¸¸:', error);
      return { success: false, error: { message: 'ç”Ÿæˆè¯„è®ºå¤±è´¥' } };
    }
  };

  // æ£€æŸ¥å¹¶æ¢å¤æœªå®Œæˆçš„ä»»åŠ¡
  const checkAndRecoverUnfinishedTasks = async (tasks: ProcessTask[]) => {
    console.log('[X Helper] æ£€æŸ¥æœªå®Œæˆçš„ä»»åŠ¡');

    const unfinishedTasks = tasks.filter(task =>
      task.status === 'processing' &&
      (task.translationStatus === 'processing' || task.commentsStatus === 'processing')
    );

    if (unfinishedTasks.length > 0) {
      console.log(`[X Helper] å‘ç° ${unfinishedTasks.length} ä¸ªæœªå®Œæˆçš„ä»»åŠ¡ï¼Œå¼€å§‹æ¢å¤çŠ¶æ€`);

      for (const task of unfinishedTasks) {
        // æ£€æŸ¥ä»»åŠ¡å¼€å§‹æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡10åˆ†é’Ÿåˆ™æ ‡è®°ä¸ºå¤±è´¥
        const taskStartTime = new Date(task.startTime).getTime();
        const now = Date.now();
        const timeDiff = now - taskStartTime;
        const timeoutThreshold = 10 * 60 * 1000; // 10åˆ†é’Ÿ

        if (timeDiff > timeoutThreshold) {
          console.log(`[X Helper] ä»»åŠ¡ ${task.id} è¶…æ—¶ï¼Œæ ‡è®°ä¸ºå¤±è´¥`);
          task.status = 'failed';
          task.error = 'ä»»åŠ¡è¶…æ—¶ï¼ˆé¡µé¢å…³é—­å¯¼è‡´ï¼‰';
          if (task.translationStatus === 'processing') {
            task.translationStatus = 'failed';
          }
          if (task.commentsStatus === 'processing') {
            task.commentsStatus = 'failed';
          }
        } else {
          // å°è¯•æ¢å¤ä»»åŠ¡çŠ¶æ€
          console.log(`[X Helper] å°è¯•æ¢å¤ä»»åŠ¡ ${task.id} çš„çŠ¶æ€`);
          await recoverTaskStatus(task);
        }
      }

      // æ›´æ–°ä»»åŠ¡å†å²
      localStorage.setItem('x-helper-task-history', JSON.stringify(tasks));
    }
  };

  // æ¢å¤å•ä¸ªä»»åŠ¡çš„çŠ¶æ€
  const recoverTaskStatus = async (task: ProcessTask) => {
    try {
      // é‡æ–°è·å–æ¨æ–‡ä¿¡æ¯çœ‹æ˜¯å¦å·²ç»æ›´æ–°
      if (task.tweetId) {
        const tweetInfoResult = await fetchTweetInfo(task.tweetId);
        if (tweetInfoResult.success && !task.tweetInfo) {
          task.tweetInfo = tweetInfoResult.data;
        }
      }

      // æ£€æŸ¥ç¿»è¯‘çŠ¶æ€
      if (task.translationStatus === 'processing') {
        if (task.tweetInfo?.translatedContent) {
          console.log(`[X Helper] ä»»åŠ¡ ${task.id} çš„ç¿»è¯‘å·²å®Œæˆ`);
          task.translationStatus = 'completed';
          task.translationResult = {
            translatedContent: task.tweetInfo.translatedContent,
            originalLanguage: task.tweetInfo.originalLanguage
          };
        } else {
          console.log(`[X Helper] ä»»åŠ¡ ${task.id} çš„ç¿»è¯‘æœªå®Œæˆï¼Œæ ‡è®°ä¸ºå¤±è´¥`);
          task.translationStatus = 'failed';
        }
      }

      // æ£€æŸ¥è¯„è®ºçŠ¶æ€ - è¿™é‡Œæ¯”è¾ƒå¤æ‚ï¼Œæš‚æ—¶æ ‡è®°ä¸ºéœ€è¦æ‰‹åŠ¨é‡è¯•
      if (task.commentsStatus === 'processing') {
        console.log(`[X Helper] ä»»åŠ¡ ${task.id} çš„è¯„è®ºå¤„ç†æœªå®Œæˆï¼Œæ ‡è®°ä¸ºå¤±è´¥`);
        task.commentsStatus = 'failed';
      }

      // æ›´æ–°æ•´ä½“ä»»åŠ¡çŠ¶æ€ï¼šå¦‚æœæ‰€æœ‰å­ä»»åŠ¡éƒ½ä¸åœ¨å¤„ç†ä¸­ï¼Œåˆ™æ ‡è®°ä¸ºå®Œæˆ
      const allSubTasksCompleted =
        (task.translationStatus === 'completed' || task.translationStatus === 'failed') &&
        (task.commentsStatus === 'completed' || task.commentsStatus === 'failed');

      if (allSubTasksCompleted) {
        task.status = 'completed';
      }

    } catch (error) {
      console.error(`[X Helper] æ¢å¤ä»»åŠ¡ ${task.id} çŠ¶æ€å¤±è´¥:`, error);
      task.status = 'failed';
      task.error = 'çŠ¶æ€æ¢å¤å¤±è´¥';
    }
  };

  // é‡è¯•ä»»åŠ¡
  const retryTask = (task: ProcessTask) => {
    console.log('[X Helper] é‡è¯•ä»»åŠ¡:', task.id);
    setTweetUrl(task.tweetUrl);
    handleProcessTweet();
  };

  // å•ç‹¬é‡è¯•ç¿»è¯‘
  const retryTranslation = async (task: ProcessTask) => {
    if (!task.tweetInfo?.content) {
      alert('ç¼ºå°‘æ¨æ–‡å†…å®¹ï¼Œæ— æ³•è¿›è¡Œç¿»è¯‘');
      return;
    }

    console.log('[X Helper] å•ç‹¬é‡è¯•ç¿»è¯‘:', task.id);

    // æ›´æ–°çŠ¶æ€
    task.translationStatus = 'processing';
    setCurrentTask({ ...task });
    setTaskHistory(prev => prev.map(t => t.id === task.id ? task : t));

    try {
      const response = await fetch('/api/tweet-processor/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content: task.tweetInfo.content,
          aiConfig: translationAIConfig
        })
      });

      const result = await response.json();
      console.log('[X Helper] ç¿»è¯‘é‡è¯•ç»“æœ:', result);

      if (result.success) {
        task.translationStatus = 'completed';
        task.translationResult = result.data;
      } else {
        task.translationStatus = 'failed';
        task.error = result.error?.message || 'ç¿»è¯‘å¤±è´¥';
      }

      setCurrentTask({ ...task });
      setTaskHistory(prev => prev.map(t => t.id === task.id ? task : t));

      // æ›´æ–°localStorage
      if (mounted) {
        const updatedHistory = taskHistory.map(t => t.id === task.id ? task : t);
        localStorage.setItem('x-helper-task-history', JSON.stringify(updatedHistory));
      }

    } catch (error) {
      console.error('[X Helper] ç¿»è¯‘é‡è¯•å¼‚å¸¸:', error);
      task.translationStatus = 'failed';
      task.error = 'ç½‘ç»œé”™è¯¯';
      setCurrentTask({ ...task });
      setTaskHistory(prev => prev.map(t => t.id === task.id ? task : t));
    }
  };

  // å•ç‹¬é‡è¯•è¯„è®º
  const retryComments = async (task: ProcessTask) => {
    if (!task.tweetId) {
      alert('ç¼ºå°‘æ¨æ–‡IDï¼Œæ— æ³•è¿›è¡Œè¯„è®ºå¤„ç†');
      return;
    }

    console.log('[X Helper] å•ç‹¬é‡è¯•è¯„è®º:', task.id);

    // æ›´æ–°çŠ¶æ€
    task.commentsStatus = 'processing';
    setCurrentTask({ ...task });
    setTaskHistory(prev => prev.map(t => t.id === task.id ? task : t));

    try {
      // å…ˆè¿›è¡Œè¯„è®ºçˆ¬å–
      const crawlResponse = await fetch('/api/tweet-processor/crawl-comments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': 'unicatcher-api-key-2024'
        },
        body: JSON.stringify({
          tweetId: task.tweetId,
          incremental: false,
          maxScrolls: 10
        })
      });

      const crawlResult = await crawlResponse.json();
      console.log('[X Helper] è¯„è®ºçˆ¬å–é‡è¯•ç»“æœ:', crawlResult);

      if (crawlResult.success) {
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        const pollResult = await pollTaskStatus(crawlResult.data.taskId);

        if (pollResult.success) {
          task.commentsResult = pollResult.data;

          // ç”Ÿæˆè¯„è®º
          const commentResult = await generateComments(task.tweetId, task.tweetInfo?.content || '');

          if (commentResult.success) {
            task.commentsStatus = 'completed';
            // ä¸ºäº†ä¿æŒå‰ç«¯ä¸€è‡´æ€§ï¼Œå°†commentsé‡å‘½åä¸ºgeneratedComments
            task.generatedCommentsResult = {
              ...commentResult.data,
              generatedComments: commentResult.data?.comments || []
            };
          } else {
            task.commentsStatus = 'failed';
            task.error = 'è¯„è®ºç”Ÿæˆå¤±è´¥';
          }
        } else {
          task.commentsStatus = 'failed';
          task.error = pollResult.error?.message || 'è¯„è®ºçˆ¬å–å¤±è´¥';
        }
      } else {
        task.commentsStatus = 'failed';
        task.error = crawlResult.error?.message || 'è¯„è®ºçˆ¬å–APIè°ƒç”¨å¤±è´¥';
      }

      setCurrentTask({ ...task });
      setTaskHistory(prev => prev.map(t => t.id === task.id ? task : t));

      // æ›´æ–°localStorage
      if (mounted) {
        const updatedHistory = taskHistory.map(t => t.id === task.id ? task : t);
        localStorage.setItem('x-helper-task-history', JSON.stringify(updatedHistory));
      }

    } catch (error) {
      console.error('[X Helper] è¯„è®ºé‡è¯•å¼‚å¸¸:', error);
      task.commentsStatus = 'failed';
      task.error = 'ç½‘ç»œé”™è¯¯';
      setCurrentTask({ ...task });
      setTaskHistory(prev => prev.map(t => t.id === task.id ? task : t));
    }
  };

  // æ¸…ç†ä»»åŠ¡ï¼ˆä»å†å²ä¸­ç§»é™¤ï¼‰
  const clearTask = (taskId: string) => {
    console.log('[X Helper] æ¸…ç†ä»»åŠ¡:', taskId);
    const updatedHistory = taskHistory.filter(task => task.id !== taskId);
    setTaskHistory(updatedHistory);
    if (currentTask?.id === taskId) {
      setCurrentTask(null);
    }
  };

  // é€‰æ‹©ä»»åŠ¡
  const selectTask = (task: ProcessTask) => {
    setCurrentTask(task);
    setTweetUrl(task.tweetUrl);
  };

  const headerActions = (
    <button
      onClick={() => setShowAIConfig(true)}
      className="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors"
    >
      <span className="mr-2">âš™ï¸</span>
      AIé…ç½®
    </button>
  );

  return (
    <DashboardLayout actions={headerActions}>
      {/* æ¢å¤çŠ¶æ€æç¤º */}
      {recoveryStatus && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div className="flex items-center">
            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
            <p className="text-blue-800">{recoveryStatus}</p>
          </div>
        </div>
      )}

      {/* ä¸»å¤„ç†åŒºåŸŸ */}
      <div className="bg-white shadow rounded-lg p-6">
        <div className="space-y-4">
          {/* URLè¾“å…¥ */}
          <div>
            <input
              type="text"
              value={tweetUrl}
              onChange={(e) => setTweetUrl(e.target.value)}
              placeholder="è¾“å…¥æ¨æ–‡URL (å¦‚: https://x.com/username/status/1234567890)"
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              disabled={isProcessing}
            />
          </div>

          {/* å¤„ç†æŒ‰é’® */}
          <div>
            <button
              onClick={handleProcessTweet}
              disabled={isProcessing || !tweetUrl.trim()}
              className="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
            >
              {isProcessing ? 'å¤„ç†ä¸­...' : 'å¤„ç†'}
            </button>
          </div>
        </div>
      </div>

      {/* å½“å‰ä»»åŠ¡å±•ç¤ºåŒºåŸŸ */}
      {currentTask && (
        <div className="bg-white shadow rounded-lg p-6">
          <div className="space-y-6">
            {/* æ¨æ–‡ä¿¡æ¯ */}
            {currentTask.tweetInfo && (
              <div className="border-b pb-6">
                <h3 className="text-lg font-medium text-gray-900 mb-4">æ¨æ–‡ä¿¡æ¯</h3>
                <div className="flex items-start space-x-4">
                  {currentTask.tweetInfo.profileImageUrl && (
                    <img
                      src={currentTask.tweetInfo.profileImageUrl}
                      alt={currentTask.tweetInfo.userNickname}
                      className="w-12 h-12 rounded-full"
                    />
                  )}
                  <div className="flex-1">
                    <div className="flex items-center space-x-2 mb-2">
                      <span className="font-medium">{currentTask.tweetInfo.userNickname}</span>
                      <span className="text-gray-500">@{currentTask.tweetInfo.userUsername}</span>
                      <span className="text-gray-500">Â·</span>
                      <span className="text-gray-500">{currentTask.tweetInfo.publishedAtFormatted}</span>
                    </div>
                    <p className="text-gray-900 mb-3">{currentTask.tweetInfo.content}</p>
                    <div className="flex items-center space-x-4 text-sm text-gray-500">
                      <span>ğŸ’¬ {currentTask.tweetInfo.commentCount}</span>
                      <span>ğŸ”„ {currentTask.tweetInfo.retweetCount}</span>
                      <span>â¤ï¸ {currentTask.tweetInfo.likeCount}</span>
                      <span>ğŸ‘ï¸ {currentTask.tweetInfo.viewCount}</span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* å¤„ç†çŠ¶æ€ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* ç¿»è¯‘çŠ¶æ€ */}
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <span className="font-medium">ç¿»è¯‘çŠ¶æ€:</span>
                    <StatusBadge status={currentTask.translationStatus} />
                  </div>
                  {currentTask.translationStatus === 'failed' && (
                    <button
                      onClick={() => retryTranslation(currentTask)}
                      className="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-md hover:bg-blue-200 transition-colors flex items-center space-x-1"
                      title="é‡è¯•ç¿»è¯‘"
                    >
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      <span>é‡è¯•</span>
                    </button>
                  )}
                </div>
                {currentTask.translationResult && (
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <p className="text-sm text-gray-600 mb-2">è¯‘æ–‡:</p>
                    <p className="text-gray-900">{currentTask.translationResult.translatedContent}</p>
                    {currentTask.translationResult.originalLanguage && (
                      <p className="text-xs text-gray-500 mt-2">
                        æ£€æµ‹è¯­è¨€: {currentTask.translationResult.originalLanguage}
                      </p>
                    )}
                  </div>
                )}
              </div>

              {/* è¯„è®ºçŠ¶æ€ */}
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <span className="font-medium">è¯„è®ºçŠ¶æ€:</span>
                    <StatusBadge status={currentTask.commentsStatus} />
                  </div>
                  {currentTask.commentsStatus === 'failed' && (
                    <button
                      onClick={() => retryComments(currentTask)}
                      className="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-md hover:bg-green-200 transition-colors flex items-center space-x-1"
                      title="é‡è¯•è¯„è®ºå¤„ç†"
                    >
                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      <span>é‡è¯•</span>
                    </button>
                  )}
                </div>
                {/* AIç”Ÿæˆè¯„è®ºç‹¬ç«‹å±•ç¤ºåŒºåŸŸ */}
                {currentTask.generatedCommentsResult && currentTask.generatedCommentsResult.generatedComments && currentTask.generatedCommentsResult.generatedComments.length > 0 && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-4">
                    <h3 className="text-lg font-medium text-blue-900 mb-4 flex items-center">
                      <span className="mr-2">ğŸ¤–</span>
                      AIç”Ÿæˆçš„å‚è€ƒè¯„è®º ({currentTask.generatedCommentsResult.generatedComments.length}æ¡)
                    </h3>
                    <div className="space-y-4">
                      {currentTask.generatedCommentsResult.generatedComments.map((comment: any, index: number) => {
                        const commentText = typeof comment === 'string' ? comment : comment.content || comment.text || JSON.stringify(comment);
                        return (
                          <div key={index} className="bg-white border border-blue-200 rounded-lg p-4 shadow-sm">
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center mb-2">
                                  <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    è¯„è®º {index + 1}
                                  </span>
                                </div>
                                <p className="text-gray-900 whitespace-pre-wrap leading-relaxed">
                                  {commentText}
                                </p>
                              </div>
                              <button
                                onClick={() => navigator.clipboard.writeText(commentText)}
                                className="ml-4 flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors"
                                title="å¤åˆ¶è¯„è®º"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <div className="mt-4 p-3 bg-blue-100 rounded-lg">
                      <p className="text-sm text-blue-700">
                        ğŸ’¡ æç¤ºï¼šè¿™äº›æ˜¯AIæ ¹æ®æ¨æ–‡å†…å®¹ç”Ÿæˆçš„å‚è€ƒè¯„è®ºï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ–ä½œä¸ºçµæ„Ÿè¿›è¡Œä¿®æ”¹ã€‚ç‚¹å‡»å³ä¸Šè§’çš„å¤åˆ¶æŒ‰é’®å¯ä»¥å¿«é€Ÿå¤åˆ¶è¯„è®ºå†…å®¹ã€‚
                      </p>
                    </div>
                  </div>
                )}

                {currentTask.commentsResult && (
                  <div className="bg-green-50 p-4 rounded-lg space-y-3">
                    <div className="flex items-center justify-between">
                      <p className="text-sm text-gray-600">
                        è·å–è¯„è®º: {currentTask.commentsResult.totalComments || 0} æ¡
                      </p>
                      {currentTask.commentsResult.comments && currentTask.commentsResult.comments.length > 0 && (
                        <span className="text-xs text-green-600">
                          â†“ æŸ¥çœ‹è¯¦ç»†è¯„è®º
                        </span>
                      )}
                    </div>

                    {/* å±•ç¤ºAIç”Ÿæˆçš„è¯„è®º */}
                    {currentTask.generatedCommentsResult && currentTask.generatedCommentsResult.generatedComments && currentTask.generatedCommentsResult.generatedComments.length > 0 && (
                      <div className="space-y-2 mb-4">
                        <p className="text-xs text-gray-500 font-medium">AIç”Ÿæˆçš„å‚è€ƒè¯„è®ºï¼š</p>
                        {currentTask.generatedCommentsResult.generatedComments.map((comment: any, index: number) => {
                          const commentText = typeof comment === 'string' ? comment : comment.content || comment.text || JSON.stringify(comment);
                          return (
                            <div key={index} className="bg-blue-50 p-3 rounded border border-blue-200 text-sm">
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center mb-1">
                                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                      AIè¯„è®º {index + 1}
                                    </span>
                                  </div>
                                  <p className="text-gray-900 whitespace-pre-wrap leading-relaxed">
                                    {commentText}
                                  </p>
                                </div>
                                <button
                                  onClick={() => navigator.clipboard.writeText(commentText)}
                                  className="ml-2 flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors"
                                  title="å¤åˆ¶è¯„è®º"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                  </svg>
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}

                    {/* å±•ç¤ºçˆ¬å–çš„è¯„è®ºåˆ—è¡¨ */}
                    {currentTask.commentsResult.comments && currentTask.commentsResult.comments.length > 0 && (
                      <div className="space-y-2 max-h-64 overflow-y-auto">
                        <p className="text-xs text-gray-500 font-medium">çˆ¬å–çš„è¯„è®ºå†…å®¹ï¼š</p>
                        {currentTask.commentsResult.comments.slice(0, 5).map((comment: any, index: number) => (
                          <div key={index} className="bg-white p-3 rounded border border-green-200 text-sm">
                            <div className="flex items-start justify-between mb-2">
                              <div className="flex items-center space-x-2">
                                {comment.authorProfileImage && (
                                  <img
                                    src={comment.authorProfileImage}
                                    alt={comment.authorNickname}
                                    className="w-6 h-6 rounded-full"
                                  />
                                )}
                                <div>
                                  <span className="font-medium text-gray-900">
                                    {comment.authorNickname || comment.authorUsername || 'åŒ¿åç”¨æˆ·'}
                                  </span>
                                  {comment.authorUsername && (
                                    <span className="text-gray-500 text-xs ml-1">
                                      @{comment.authorUsername}
                                    </span>
                                  )}
                                </div>
                              </div>
                              <button
                                onClick={() => navigator.clipboard.writeText(comment.content || '')}
                                className="text-gray-400 hover:text-gray-600 transition-colors"
                                title="å¤åˆ¶è¯„è®º"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                              </button>
                            </div>
                            <p className="text-gray-800 leading-relaxed">
                              {comment.content || 'æ— å†…å®¹'}
                            </p>
                            <div className="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                              {comment.likeCount !== undefined && (
                                <span>â¤ï¸ {comment.likeCount}</span>
                              )}
                              {comment.replyCount !== undefined && (
                                <span>ğŸ’¬ {comment.replyCount}</span>
                              )}
                              {comment.publishedAt && (
                                <span>{new Date(Number(comment.publishedAt)).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                              )}
                            </div>
                          </div>
                        ))}
                        {currentTask.commentsResult.comments.length > 5 && (
                          <div className="text-center py-2">
                            <span className="text-xs text-gray-500">
                              â€¦è¿˜æœ‰ {currentTask.commentsResult.comments.length - 5} æ¡è¯„è®ºæœªæ˜¾ç¤º
                            </span>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
                {currentTask.generatedCommentsResult && (
                  <div className="bg-orange-50 p-4 rounded-lg">
                    <p className="text-sm text-gray-600">
                      AIç”Ÿæˆè¯„è®º: {currentTask.generatedCommentsResult.generatedComments?.length || 0} æ¡
                    </p>
                    <p className="text-xs text-orange-600 mt-1">
                      â†“ è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„â€œAIç”Ÿæˆçš„å‚è€ƒè¯„è®ºâ€åŒºåŸŸ
                    </p>
                  </div>
                )}
              </div>
            </div>


            {/* é”™è¯¯ä¿¡æ¯ */}
            {currentTask.error && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <p className="text-red-800">{currentTask.error}</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ä»»åŠ¡å†å² */}
      {mounted && taskHistory.length > 0 && (
        <div className="bg-white shadow rounded-lg p-6">
          <h3 className="text-lg font-medium text-gray-900 mb-4">å¤„ç†å†å²</h3>
          <div className="space-y-3">
            {taskHistory.map((task) => (
              <div
                key={task.id}
                onClick={() => selectTask(task)}
                className={`p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${
                  currentTask?.id === task.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'
                }`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <p className="font-medium text-gray-900 truncate">
                      {task.tweetInfo?.userNickname || task.tweetUrl}
                    </p>
                    <p className="text-sm text-gray-500">{task.startTime}</p>
                    {task.error && (
                      <p className="text-xs text-red-600 mt-1">é”™è¯¯: {task.error}</p>
                    )}
                  </div>
                  <div className="flex items-center space-x-2">
                    <StatusBadge status={task.translationStatus} size="sm" />
                    <StatusBadge status={task.commentsStatus} size="sm" />

                    {/* æ“ä½œæŒ‰é’® */}
                    <div className="flex items-center space-x-1 ml-2">
                      {task.status === 'failed' && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            retryTask(task);
                          }}
                          className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
                          title="é‡è¯•ä»»åŠ¡"
                        >
                          é‡è¯•
                        </button>
                      )}
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          clearTask(task.id);
                        }}
                        className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200"
                        title="ä»å†å²ä¸­ç§»é™¤"
                      >
                        æ¸…ç†
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* AIé…ç½®å¼¹çª— */}
      {showAIConfig && (
        <AIConfigModal
          translationConfig={translationAIConfig}
          commentConfig={commentAIConfig}
          onTranslationConfigChange={setTranslationAIConfig}
          onCommentConfigChange={setCommentAIConfig}
          onSave={saveAIConfigs}
          onCancel={() => setShowAIConfig(false)}
        />
      )}
    </DashboardLayout>
  );
}

function StatusBadge({ status, size = 'md' }: { status: string; size?: 'sm' | 'md' }) {
  const sizeClasses = size === 'sm' ? 'px-2 py-1 text-xs' : 'px-3 py-1 text-sm';

  switch (status) {
    case 'pending':
      return <span className={`${sizeClasses} bg-gray-100 text-gray-700 rounded-full`}>å¾…å¤„ç†</span>;
    case 'processing':
      return <span className={`${sizeClasses} bg-blue-100 text-blue-700 rounded-full`}>å¤„ç†ä¸­</span>;
    case 'completed':
      return <span className={`${sizeClasses} bg-green-100 text-green-700 rounded-full`}>å®Œæˆ</span>;
    case 'failed':
      return <span className={`${sizeClasses} bg-red-100 text-red-700 rounded-full`}>å¤±è´¥</span>;
    default:
      return <span className={`${sizeClasses} bg-gray-100 text-gray-700 rounded-full`}>æœªçŸ¥</span>;
  }
}

function AIConfigModal({
  translationConfig,
  commentConfig,
  onTranslationConfigChange,
  onCommentConfigChange,
  onSave,
  onCancel
}: {
  translationConfig: AIConfig;
  commentConfig: AIConfig;
  onTranslationConfigChange: (config: AIConfig) => void;
  onCommentConfigChange: (config: AIConfig) => void;
  onSave: () => void;
  onCancel: () => void;
}) {
  // æ ¹æ®ä¾›åº”å•†è·å–å¯é€‰æ¨¡å‹
  const getModelsForProvider = (provider: string) => {
    switch (provider) {
      case 'openai':
        return [
          { value: 'gpt-4o', label: 'GPT-4o' },
          { value: 'gpt-4', label: 'GPT-4' },
          { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' }
        ];
      case 'openai-badger':
        return [
          { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
          { value: 'gpt-4o', label: 'GPT-4o' },
          { value: 'gpt-4', label: 'GPT-4' },
          { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' }
        ];
      case 'zhipu':
        return [
          { value: 'glm-4.5-flash', label: 'GLM-4.5-Flash' },
          { value: 'glm-4.5', label: 'GLM-4.5' },
          { value: 'glm-4.5-air', label: 'GLM-4.5-Air' }
        ];
      default:
        return [];
    }
  };

  // è·å–ä¾›åº”å•†çš„é»˜è®¤æ¨¡å‹
  const getDefaultModelForProvider = (provider: string) => {
    switch (provider) {
      case 'openai':
        return 'gpt-4o';
      case 'openai-badger':
        return 'gpt-4o-mini';
      case 'zhipu':
        return 'glm-4.5-flash';
      default:
        return '';
    }
  };

  // å¤„ç†ç¿»è¯‘AIä¾›åº”å•†å˜æ›´
  const handleTranslationProviderChange = (provider: string) => {
    const defaultModel = getDefaultModelForProvider(provider);
    onTranslationConfigChange({
      ...translationConfig,
      provider: provider as AIConfig['provider'],
      model: defaultModel
    });
  };

  // å¤„ç†è¯„è®ºAIä¾›åº”å•†å˜æ›´
  const handleCommentProviderChange = (provider: string) => {
    const defaultModel = getDefaultModelForProvider(provider);
    onCommentConfigChange({
      ...commentConfig,
      provider: provider as AIConfig['provider'],
      model: defaultModel
    });
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
        <h3 className="text-lg font-semibold mb-6">AIé…ç½®</h3>

        <div className="space-y-8">
          {/* ç¿»è¯‘AIé…ç½® */}
          <div>
            <h4 className="text-md font-medium mb-4">ç¿»è¯‘AI</h4>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">APIå¯†é’¥</label>
                <input
                  type="password"
                  value={translationConfig.apiKey}
                  onChange={(e) => onTranslationConfigChange({ ...translationConfig, apiKey: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¾“å…¥ç¿»è¯‘APIå¯†é’¥"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ä¾›åº”å•†</label>
                <select
                  value={translationConfig.provider}
                  onChange={(e) => handleTranslationProviderChange(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="openai">OpenAI</option>
                  <option value="openai-badger">OpenAI-Badger</option>
                  <option value="zhipu">æ™ºè°±AI (GLM)</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                <select
                  value={translationConfig.model}
                  onChange={(e) => onTranslationConfigChange({ ...translationConfig, model: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  {getModelsForProvider(translationConfig.provider).map(model => (
                    <option key={model.value} value={model.value}>{model.label}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">åŸºç¡€URL (å¯é€‰)</label>
                <input
                  type="url"
                  value={translationConfig.baseURL || ''}
                  onChange={(e) => onTranslationConfigChange({ ...translationConfig, baseURL: e.target.value || undefined })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è‡ªå®šä¹‰APIç«¯ç‚¹URL"
                />
              </div>
            </div>
          </div>

          {/* è¯„è®ºAIé…ç½® */}
          <div>
            <h4 className="text-md font-medium mb-4">è¯„è®ºAI</h4>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">APIå¯†é’¥</label>
                <input
                  type="password"
                  value={commentConfig.apiKey}
                  onChange={(e) => onCommentConfigChange({ ...commentConfig, apiKey: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è¾“å…¥è¯„è®ºAPIå¯†é’¥"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ä¾›åº”å•†</label>
                <select
                  value={commentConfig.provider}
                  onChange={(e) => handleCommentProviderChange(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="openai">OpenAI</option>
                  <option value="openai-badger">OpenAI-Badger</option>
                  <option value="zhipu">æ™ºè°±AI (GLM)</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                <select
                  value={commentConfig.model}
                  onChange={(e) => onCommentConfigChange({ ...commentConfig, model: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  {getModelsForProvider(commentConfig.provider).map(model => (
                    <option key={model.value} value={model.value}>{model.label}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">åŸºç¡€URL (å¯é€‰)</label>
                <input
                  type="url"
                  value={commentConfig.baseURL || ''}
                  onChange={(e) => onCommentConfigChange({ ...commentConfig, baseURL: e.target.value || undefined })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="è‡ªå®šä¹‰APIç«¯ç‚¹URL"
                />
              </div>
            </div>
          </div>
        </div>

        <div className="flex justify-end space-x-3 mt-8">
          <button
            onClick={onCancel}
            className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={onSave}
            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
          >
            ä¿å­˜é…ç½®
          </button>
        </div>
      </div>
    </div>
  );
}