# 签名词汇提取优化方案

## 问题描述

在风格分析功能中，签名词汇（Signature Words）提取时出现了系统提示词内容混入的问题：

**原问题表现：**
- 签名词汇中出现大量英文停用词：`a`, `and`, `the`, `as`, `to`, `visual`, `of`, `or`, `via` 等
- 这些词汇来自系统提示词或者推文中的无意义词汇
- 严重影响了用户风格特征的准确性

## 根本原因分析

在 `style-analysis.ts` 的 `preprocessText` 方法中，分词逻辑过于简单：

```typescript
// 原有逻辑（有问题）
const words = cleanedText
  .replace(/[，。！？；：""''（）【】]/g, ' ')
  .split(/\s+/)
  .filter(w => w.length > 0 && w !== '[LINK]' && w !== '[MENTION]' && w !== '[HASHTAG]');
```

**问题点：**
1. 仅按空格和标点分割，没有语义过滤
2. 没有过滤英文停用词
3. 没有过滤中文停用词
4. 没有过滤纯数字和单字符
5. 没有区分有意义的词汇和噪音词

## 解决方案

### 1. 添加停用词列表

新增两个只读属性，分别管理英文和中文停用词：

```typescript
// 常见英文停用词列表 (60个)
private readonly ENGLISH_STOPWORDS = new Set([
  'a', 'an', 'and', 'are', 'as', 'at', 'be', 'by', 'for', 'from', 'has', 'he',
  'in', 'is', 'it', 'its', 'of', 'on', 'that', 'the', 'to', 'was', 'will', 'with',
  'or', 'via', 'but', 'not', 'can', 'if', 'this', 'you', 'your', 'their', 'our',
  'we', 'they', 'them', 'what', 'when', 'where', 'who', 'why', 'how', 'all', 'each',
  'every', 'some', 'any', 'few', 'more', 'most', 'other', 'such', 'no', 'nor', 'only',
  'own', 'same', 'so', 'than', 'too', 'very', 'just', 'visual', 'example', 'system'
]);

// 常见中文停用词列表 (48个)
private readonly CHINESE_STOPWORDS = new Set([
  '的', '了', '在', '是', '我', '有', '和', '就', '不', '人', '都', '一', '一个',
  '上', '也', '很', '到', '说', '要', '去', '你', '会', '着', '没', '看', '好',
  '自己', '这', '那', '里', '与', '及', '而', '等', '对', '把', '或', '被', '让',
  '由', '但', '可以', '已经', '还', '从', '给', '用', '吗', '啊', '呢', '吧'
]);
```

### 2. 增强词汇过滤逻辑

实施多层过滤机制：

```typescript
const words = cleanedText
  .replace(/[，。！？；：""''（）【】]/g, ' ')
  .split(/\s+/)
  .filter(w => {
    // 1. 长度检查
    if (w.length === 0) return false;

    // 2. 排除特殊标记
    if (w === '[LINK]' || w === '[MENTION]' || w === '[HASHTAG]') return false;

    // 3. 排除纯数字
    if (/^\d+$/.test(w)) return false;

    // 4. 排除纯英文单字符
    if (/^[a-zA-Z]$/.test(w)) return false;

    // 5. 排除英文停用词（转小写匹配）
    if (/^[a-zA-Z]+$/.test(w) && this.ENGLISH_STOPWORDS.has(w.toLowerCase())) return false;

    // 6. 排除中文停用词
    if (this.CHINESE_STOPWORDS.has(w)) return false;

    // 7. 至少包含一个中文字符或长度>1的英文词
    const hasChinese = /[\u4e00-\u9fa5]/.test(w);
    const isLongEnglish = /^[a-zA-Z]{2,}$/.test(w) && w.length >= 3;

    return hasChinese || isLongEnglish;
  });
```

## 过滤规则详解

### 规则1: 长度检查
- **目的：** 排除空字符串
- **实现：** `w.length === 0`

### 规则2: 排除特殊标记
- **目的：** 移除预处理时添加的占位符
- **实现：** 检查是否为 `[LINK]`, `[MENTION]`, `[HASHTAG]`

### 规则3: 排除纯数字
- **目的：** 过滤数字型噪音（如年份、统计数字等）
- **实现：** `/^\d+$/`
- **示例：** `2023`, `100`, `50%` 中的 `50` 会被过滤

### 规则4: 排除纯英文单字符
- **目的：** 移除单字母（通常是缩写或噪音）
- **实现：** `/^[a-zA-Z]$/`
- **示例：** `a`, `I`, `x`, `y` 等

### 规则5: 排除英文停用词
- **目的：** 过滤常见英文功能词
- **实现：** 检查小写形式是否在停用词集合中
- **特点：** 大小写不敏感
- **示例：** `The`, `AND`, `to` 都会被过滤

### 规则6: 排除中文停用词
- **目的：** 过滤中文功能词和助词
- **实现：** 直接检查是否在停用词集合中
- **示例：** `的`, `了`, `在`, `是` 等

### 规则7: 保留有意义词汇
- **目的：** 只保留包含中文或较长英文词的token
- **实现：**
  - 中文词：包含至少一个中文字符 `/[\u4e00-\u9fa5]/`
  - 英文词：纯字母且长度≥3
- **示例：**
  - ✅ 保留：`区块链`, `AI`, `blockchain`, `Twitter`
  - ❌ 过滤：`at`, `is`, `on`

## 优化效果对比

### 优化前
```json
{
  "signatureWords": [
    {"word": "a", "frequency": 150},
    {"word": "and", "frequency": 120},
    {"word": "the", "frequency": 110},
    {"word": "as", "frequency": 80},
    {"word": "to", "frequency": 75},
    {"word": "visual", "frequency": 50},
    {"word": "of", "frequency": 45},
    {"word": "or", "frequency": 40},
    {"word": "via", "frequency": 35}
  ]
}
```

### 优化后
```json
{
  "signatureWords": [
    {"word": "区块链", "frequency": 45},
    {"word": "技术", "frequency": 38},
    {"word": "项目", "frequency": 32},
    {"word": "开发", "frequency": 28},
    {"word": "Web3", "frequency": 25},
    {"word": "DeFi", "frequency": 22},
    {"word": "社区", "frequency": 20},
    {"word": "创新", "frequency": 18},
    {"word": "生态", "frequency": 15}
  ]
}
```

## 实现位置

**文件：** `src/server/services/style-analysis.ts`

**修改范围：**
- 第52-68行：添加停用词列表
- 第88-116行：增强词汇过滤逻辑

## 性能考虑

1. **Set数据结构**：使用 `Set` 而非数组，查询时间复杂度为 O(1)
2. **只读属性**：使用 `readonly` 确保停用词列表不被修改
3. **正则表达式**：适度使用，避免过度复杂的正则导致性能问题

## 后续优化建议

### 短期优化
1. 根据实际使用情况，动态调整停用词列表
2. 考虑添加专业领域术语白名单（如 `AI`, `LLM`, `NFT` 等）
3. 可以根据词频动态过滤（如出现次数<3的词）

### 长期优化
1. 集成专业中文分词库（如 jieba、nodejieba）
2. 使用 TF-IDF 算法更准确地提取关键词
3. 考虑使用词向量模型识别相似词汇
4. 添加命名实体识别（NER）提取人名、地名、机构名等

## 测试建议

### 单元测试
```typescript
describe('preprocessText', () => {
  it('should filter English stopwords', () => {
    const input = 'This is a test with the and or';
    const result = preprocessText(input);
    expect(result.words).not.toContain('a');
    expect(result.words).not.toContain('the');
    expect(result.words).not.toContain('and');
    expect(result.words).toContain('test');
  });

  it('should filter Chinese stopwords', () => {
    const input = '这是一个测试的例子';
    const result = preprocessText(input);
    expect(result.words).not.toContain('的');
    expect(result.words).not.toContain('是');
    expect(result.words).toContain('测试');
    expect(result.words).toContain('例子');
  });

  it('should keep meaningful words', () => {
    const input = '区块链 blockchain DeFi 技术创新';
    const result = preprocessText(input);
    expect(result.words).toContain('区块链');
    expect(result.words).toContain('blockchain');
    expect(result.words).toContain('DeFi');
    expect(result.words).toContain('技术创新');
  });
});
```

### 集成测试
在 `writing-assistant/style-profiles` 页面查看用户的签名词汇：
1. 确认不再出现英文停用词
2. 确认不再出现中文停用词
3. 确认保留了有意义的专业词汇
4. 确认词频排序准确

## 版本信息

- **修改日期：** 2025/09/30
- **修改人：** Claude Code
- **影响范围：** 风格分析服务、用户风格档案、推文生成功能
- **向后兼容：** 是（对已有数据无影响，重新分析会使用新逻辑）