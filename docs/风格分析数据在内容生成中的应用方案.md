# 风格分析数据在内容生成中的应用方案

## 📋 概述

本文档详细说明如何将用户写作风格分析数据应用到个性化内容生成流程中，实现真正的"以用户风格生成内容"。

## 🎯 核心思路

当前系统有三个关键环节：
1. **风格分析** → 提取用户写作特征
2. **内容生成** → 基于主题生成文章
3. **个性化注入** → 将风格特征注入到生成过程

## 📊 可用的风格数据及其应用场景

### 1. 基础风格特征（已实现）

#### 1.1 词汇特征
```typescript
{
  vocabDiversity: 0.65,        // 词汇多样性
  wordComplexity: 0.42,        // 词汇复杂度
  signatureWords: ["AI", "技术", "创新", ...]  // 签名词汇
}
```

**应用方式：**
```typescript
// 在大纲生成阶段注入
const outlinePrompt = `
请生成关于"${topic}"的大纲。

用户写作风格特征：
- 词汇多样性：${profile.vocabDiversity > 0.6 ? '高' : '中等'}，请使用${profile.vocabDiversity > 0.6 ? '丰富多样的' : '简洁明了的'}词汇
- 词汇复杂度：${profile.wordComplexity > 0.5 ? '高' : '低'}，请使用${profile.wordComplexity > 0.5 ? '专业术语和长词' : '简单易懂的词汇'}
- 常用词汇：${profile.signatureWords.slice(0, 5).join('、')}，请在合适的地方使用这些词汇

大纲要求：
- 符合用户的词汇使用习惯
- 保持专业度和可读性的平衡
`;
```

#### 1.2 句子特征
```typescript
{
  avgSentenceLength: 25.5,     // 平均句长
  sentenceTypeDist: {          // 句型分布
    declarative: 0.7,          // 陈述句70%
    interrogative: 0.15,       // 疑问句15%
    exclamatory: 0.10,        // 感叹句10%
    imperative: 0.05          // 祈使句5%
  }
}
```

**应用方式：**
```typescript
const writingGuidelines = `
句子风格要求：
- 平均句长：${profile.avgSentenceLength}字左右
- 句型分布：
  * 陈述句占${(profile.sentenceTypeDist.declarative * 100).toFixed(0)}%
  * 疑问句占${(profile.sentenceTypeDist.interrogative * 100).toFixed(0)}%
  * 感叹句占${(profile.sentenceTypeDist.exclamatory * 100).toFixed(0)}%
  ${profile.sentenceTypeDist.interrogative > 0.2 ? '\n  * 多使用疑问句与读者互动' : ''}
  ${profile.sentenceTypeDist.exclamatory > 0.15 ? '\n  * 适当使用感叹句增强感染力' : ''}
`;
```

#### 1.3 专业度特征
```typescript
{
  technicalTermUsage: 0.35,           // 专业术语使用率
  industryKnowledgeLevel: 'expert'    // 行业知识水平
}
```

**应用方式：**
```typescript
const expertiseLevel = profile.industryKnowledgeLevel;
const technicalDensity = profile.technicalTermUsage;

const styleInstruction = `
专业度要求：
- 知识水平：${expertiseLevel === 'expert' ? '专家级，可以深入技术细节' :
              expertiseLevel === 'intermediate' ? '中级，需要平衡专业性和易懂性' :
              '入门级，使用简单易懂的语言'}
- 专业术语密度：${(technicalDensity * 100).toFixed(0)}%
${technicalDensity > 0.3 ? '- 可以使用较多专业术语，但需要适当解释' : ''}
${technicalDensity < 0.15 ? '- 尽量使用通俗语言，少用专业术语' : ''}
`;
```

#### 1.4 类型化风格（按推文类型）
```typescript
{
  contentType: "科普",
  commonOpenings: ["你知道吗", "最近发现", "很多人不知道"],
  commonClosings: ["希望对你有帮助", "欢迎讨论"],
  avgContentLength: 280,
  toneFeatures: {
    formal: 0.6,
    casual: 0.4,
    humorous: 0.2
  }
}
```

**应用方式：**
```typescript
// 根据内容类型加载对应风格档案
const typeProfile = await getStyleProfileByType(username, contentType);

const structureGuide = `
内容类型：${contentType}

开头风格（从用户常用模式中选择）：
${typeProfile.commonOpenings.map((pattern, i) => `${i+1}. ${pattern}`).join('\n')}

结尾风格（从用户常用模式中选择）：
${typeProfile.commonClosings.map((pattern, i) => `${i+1}. ${pattern}`).join('\n')}

语气特征：
- 正式度：${(typeProfile.toneFeatures.formal * 100).toFixed(0)}%
- 随意度：${(typeProfile.toneFeatures.casual * 100).toFixed(0)}%
- 幽默度：${(typeProfile.toneFeatures.humorous * 100).toFixed(0)}%

内容长度：约${typeProfile.avgContentLength}字
`;
```

### 2. 进阶风格特征（待实现）

#### 2.1 开头模式（待实现）
```typescript
{
  questionHook: 0.3,      // 30%使用疑问开头
  dataHook: 0.25,         // 25%使用数据开头
  storyHook: 0.2,         // 20%使用故事开头
  statementHook: 0.15,    // 15%使用陈述开头
  contrastHook: 0.1       // 10%使用对比开头
}
```

**应用方式：**
```typescript
// 根据用户最常用的开头模式生成
const openingStyle = getTopOpeningPattern(profile.openingPatterns);

const openingInstruction = `
开头策略（基于用户习惯）：
${openingStyle === 'questionHook' ? `
- 使用疑问句开头，引发读者思考
- 示例："你知道...吗？"、"为什么...？"
` : ''}
${openingStyle === 'dataHook' ? `
- 使用数据或研究开头，建立权威性
- 示例："数据显示..."、"研究表明..."
` : ''}
${openingStyle === 'storyHook' ? `
- 使用个人故事或案例开头，增强共鸣
- 示例："昨天遇到..."、"最近发现..."
` : ''}
`;
```

#### 2.2 吸引力因素（待实现）
```typescript
{
  noveltyScore: 0.7,          // 新颖性
  controversyScore: 0.3,      // 争议性
  practicalityScore: 0.8,     // 实用性
  emotionalResonance: 0.6     // 情感共鸣
}
```

**应用方式：**
```typescript
const attractionGuide = `
内容吸引力优化方向（基于用户成功模式）：

${profile.noveltyScore > 0.6 ? `
✓ 新颖性（高）：
  - 介绍新概念、新发现、新数据
  - 使用"首次"、"最新"、"突破"等词汇
` : ''}

${profile.practicalityScore > 0.7 ? `
✓ 实用性（高）：
  - 提供具体方法、步骤、工具
  - 使用"如何"、"技巧"、"攻略"等词汇
` : ''}

${profile.emotionalResonance > 0.5 ? `
✓ 情感共鸣（高）：
  - 使用第一人称"我觉得"、"我发现"
  - 分享个人感受和体会
` : ''}

${profile.controversyScore > 0.4 ? `
✓ 争议性（中高）：
  - 提出不同观点或质疑
  - 使用"但是"、"然而"、"质疑"等词汇
` : ''}
`;
```

#### 2.3 情绪钩子（待实现）
```typescript
{
  openingHooks: {
    curiosityGap: { effectiveness: 0.8, examples: [...] },
    personalStory: { effectiveness: 0.7, examples: [...] },
    dataShock: { effectiveness: 0.6, examples: [...] }
  },
  closingHooks: {
    callToAction: 0.5,       // "你怎么看？"
    thoughtProvoking: 0.3    // "这让我们思考..."
  }
}
```

**应用方式：**
```typescript
// 选择用户最有效的钩子类型
const topHook = getTopEffectiveHook(profile.openingHooks);

const hookInstruction = `
情绪钩子设计（基于用户高效模式）：

开头钩子：使用${topHook.type}
示例：${topHook.examples.slice(0, 3).join('\n')}

结尾钩子：
${profile.closingHooks.callToAction > 0.4 ? '- 以行动号召结尾，如"你怎么看？"' : ''}
${profile.closingHooks.thoughtProvoking > 0.3 ? '- 以引发思考结尾，如"这让我们反思..."' : ''}
`;
```

## 🏗️ 实现架构

### 阶段1：扩展 generateOutline 函数

```typescript
async function generateOutline(task: any): Promise<string> {
  // 1. 加载用户风格档案
  let styleProfile = null;
  let styleInstructions = '';

  if (task.username && task.contentType) {
    styleProfile = await db.userStyleProfile.findUnique({
      where: {
        username_contentType: {
          username: task.username,
          contentType: task.contentType
        }
      }
    });

    if (styleProfile) {
      styleInstructions = buildStyleInstructions(styleProfile);
    }
  }

  // 2. 构建大纲生成提示词
  const prompt = `
请为以下主题生成文章大纲：

主题：${task.topic}
平台：${task.platform.name}
内容类型：${task.contentType || '通用'}

${styleInstructions}

要求：
1. 大纲应包含3-5个主要部分
2. 每个部分有明确的小标题和要点
3. 整体逻辑连贯，符合用户写作风格
`;

  // 3. 调用AI生成
  const aiService = AIServiceFactory.createService({...});
  const outline = await aiService.generateText(prompt);

  return outline;
}

// 构建风格指令
function buildStyleInstructions(profile: UserStyleProfile): string {
  const instructions: string[] = [];

  // 词汇特征
  if (profile.vocabDiversity) {
    instructions.push(`
词汇使用：
- 词汇多样性：${profile.vocabDiversity > 0.6 ? '丰富多样' : '简洁明了'}
- 词汇复杂度：${profile.wordComplexity > 0.5 ? '使用专业术语' : '使用通俗语言'}
${profile.signatureWords ? `- 常用词汇：${JSON.parse(profile.signatureWords).slice(0, 5).join('、')}` : ''}
`);
  }

  // 句子特征
  if (profile.avgSentenceLength) {
    instructions.push(`
句子风格：
- 平均句长：${profile.avgSentenceLength.toFixed(0)}字
${profile.sentenceTypeDist ? `- 句型分布：${formatSentenceTypeDist(profile.sentenceTypeDist)}` : ''}
`);
  }

  // 专业度
  if (profile.technicalTermUsage !== null) {
    instructions.push(`
专业度：
- 知识水平：${profile.industryKnowledgeLevel || 'intermediate'}
- 专业术语使用率：${(profile.technicalTermUsage * 100).toFixed(0)}%
`);
  }

  // 开头结尾模式
  if (profile.commonOpenings) {
    const openings = JSON.parse(profile.commonOpenings);
    instructions.push(`
开头模式（从中选择）：
${openings.slice(0, 3).map((p: string, i: number) => `${i+1}. ${p}`).join('\n')}
`);
  }

  if (profile.commonClosings) {
    const closings = JSON.parse(profile.commonClosings);
    instructions.push(`
结尾模式（从中选择）：
${closings.slice(0, 3).map((p: string, i: number) => `${i+1}. ${p}`).join('\n')}
`);
  }

  // 语气特征
  if (profile.toneFeatures) {
    const tone = JSON.parse(profile.toneFeatures);
    instructions.push(`
语气特征：
${Object.entries(tone).map(([key, value]) =>
  `- ${key}: ${((value as number) * 100).toFixed(0)}%`
).join('\n')}
`);
  }

  return instructions.length > 0
    ? `\n用户写作风格特征：\n${instructions.join('\n')}`
    : '';
}
```

### 阶段2：扩展 generateContent 函数

```typescript
async function generateContent(task: any, outline: string): Promise<string> {
  // 1. 加载用户风格档案
  let styleProfile = null;
  if (task.username && task.contentType) {
    styleProfile = await db.userStyleProfile.findUnique({
      where: {
        username_contentType: {
          username: task.username,
          contentType: task.contentType
        }
      }
    });
  }

  // 2. 构建详细的风格指令
  const styleGuide = styleProfile
    ? buildDetailedStyleGuide(styleProfile)
    : '';

  const prompt = `
基于以下大纲，撰写完整文章：

${outline}

${styleGuide}

写作要求：
1. 严格按照风格指令撰写
2. 保持内容的连贯性和逻辑性
3. 每个部分都要充实饱满
4. 整体符合用户的写作习惯
`;

  const aiService = AIServiceFactory.createService({...});
  const content = await aiService.generateText(prompt);

  return content;
}

function buildDetailedStyleGuide(profile: UserStyleProfile): string {
  return `
========== 用户写作风格指南 ==========

【词汇层面】
${profile.vocabDiversity ? `- 词汇丰富度：${(profile.vocabDiversity * 100).toFixed(0)}%` : ''}
${profile.wordComplexity ? `- 词汇复杂度：${(profile.wordComplexity * 100).toFixed(0)}%` : ''}
${profile.signatureWords ? `- 标志性词汇：${JSON.parse(profile.signatureWords).slice(0, 10).join('、')}` : ''}

【句子层面】
${profile.avgSentenceLength ? `- 平均句长：${profile.avgSentenceLength.toFixed(0)}字` : ''}
${profile.sentenceTypeDist ? `- 句型分布：${formatSentenceTypeDist(profile.sentenceTypeDist)}` : ''}

【内容组织】
${profile.commonOpenings ? `- 常用开头：${JSON.parse(profile.commonOpenings).slice(0, 3).join('；')}` : ''}
${profile.commonClosings ? `- 常用结尾：${JSON.parse(profile.commonClosings).slice(0, 3).join('；')}` : ''}
${profile.avgContentLength ? `- 典型长度：约${profile.avgContentLength.toFixed(0)}字` : ''}

【专业度】
- 专业水平：${profile.industryKnowledgeLevel || '中级'}
${profile.technicalTermUsage ? `- 术语密度：${(profile.technicalTermUsage * 100).toFixed(0)}%` : ''}

【语气风格】
${profile.toneFeatures ? formatToneFeatures(profile.toneFeatures) : ''}

=====================================

请严格按照以上风格指南撰写内容！
`;
}
```

### 阶段3：优化和反馈循环

```typescript
async function refineContent(
  task: any,
  content: string,
  feedback: string
): Promise<string> {
  // 获取用户风格档案
  const styleProfile = await db.userStyleProfile.findUnique({
    where: {
      username_contentType: {
        username: task.username,
        contentType: task.contentType
      }
    }
  });

  const styleReminder = styleProfile
    ? `\n注意：修改时仍需保持用户的写作风格：\n${buildStyleInstructions(styleProfile)}`
    : '';

  const prompt = `
原文：
${content}

反馈意见：
${feedback}

${styleReminder}

请根据反馈意见优化文章，同时保持用户的写作风格特征。
`;

  const aiService = AIServiceFactory.createService({...});
  const refinedContent = await aiService.generateText(prompt);

  return refinedContent;
}
```

## 🎨 前端界面增强

在内容生成页面添加用户选择：

```typescript
// 添加用户名选择
const [selectedUsername, setSelectedUsername] = useState<string>('');

// 查询可用用户列表
const { data: availableUsers } = api.styleProfiles.getUsernames.useQuery();

// 根据选中用户和内容类型，显示风格预览
const { data: stylePreview } = api.styleProfiles.getByUsername.useQuery(
  { username: selectedUsername },
  { enabled: !!selectedUsername }
);

// 在表单中添加
<select value={selectedUsername} onChange={(e) => setSelectedUsername(e.target.value)}>
  <option value="">不使用个性化风格</option>
  {availableUsers?.data?.users.map(user => (
    <option key={user.username} value={user.username}>
      @{user.username} ({user.profileCount}个风格档案)
    </option>
  ))}
</select>

// 显示风格预览
{stylePreview && (
  <div className="风格预览卡片">
    <h3>风格特征预览</h3>
    <ul>
      <li>词汇多样性：{(stylePreview.vocabDiversity * 100).toFixed(0)}%</li>
      <li>平均句长：{stylePreview.avgSentenceLength}字</li>
      <li>专业度：{stylePreview.industryKnowledgeLevel}</li>
      ...
    </ul>
  </div>
)}
```

## 📈 效果预期

实施后，系统将能够：

1. ✅ **真正的个性化**：生成的内容不仅符合主题，还符合用户的写作习惯
2. ✅ **风格一致性**：多次生成的内容保持一致的风格
3. ✅ **可控性**：用户可以选择使用或不使用个性化风格
4. ✅ **可扩展性**：随着分析维度增加（开头模式、钩子等），生成质量持续提升

## 🚀 实施步骤

1. **第一步**：修改 `generateOutline` 函数，注入基础风格指令（词汇、句子、专业度）
2. **第二步**：修改 `generateContent` 函数，注入详细风格指南
3. **第三步**：修改前端界面，添加用户选择和风格预览
4. **第四步**：实施进阶风格分析（开头模式、钩子等）
5. **第五步**：持续优化提示词和风格注入策略

要开始实施吗？