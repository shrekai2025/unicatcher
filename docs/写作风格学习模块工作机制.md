# å†™ä½œé£æ ¼å­¦ä¹ æ¨¡å—å·¥ä½œæœºåˆ¶è¯¦è§£

## ğŸ§  æ ¸å¿ƒå·¥ä½œæµç¨‹

### æ•´ä½“æ¶æ„
```mermaid
graph TD
    A[ç”¨æˆ·æ¨æ–‡æ•°æ®] --> B[é£æ ¼åˆ†ææœåŠ¡]
    B --> C[è¯æ±‡ç‰¹å¾åˆ†æ]
    B --> D[å¥æ³•ç‰¹å¾åˆ†æ]
    B --> E[ç±»å‹é£æ ¼åˆ†æ]
    B --> F[ä¸“ä¸šåº¦åˆ†æ]
    C --> G[é£æ ¼æ¡£æ¡ˆ]
    D --> G
    E --> G
    F --> G
    G --> H[æ•°æ®åº“å­˜å‚¨]
    G --> I[APIè¿”å›]
```

## ğŸ“Š å››å¤§åˆ†æç»´åº¦

### 1. è¯æ±‡ç‰¹å¾åˆ†æ (Lexical Features)

**ç›®æ ‡**: åˆ†æç”¨æˆ·çš„ç”¨è¯ä¹ æƒ¯å’Œè¯æ±‡ç‰¹å¾

**å…·ä½“æŒ‡æ ‡**:
```typescript
lexical: {
  signatureWords: Array<{word: string, frequency: number, tfidf: number}>;
  vocabDiversity: number;    // è¯æ±‡ä¸°å¯Œåº¦ (TTR = unique/total)
  wordComplexity: number;    // å¹³å‡è¯é•¿
  posDistribution: Record<string, number>; // è¯æ€§åˆ†å¸ƒ
}
```

**å·¥ä½œæœºåˆ¶**:
```javascript
// 1. æ–‡æœ¬é¢„å¤„ç†
const {words} = this.preprocessText(tweet.content);
// "ä»Šå¤©å­¦ä¹ äº†æœºå™¨å­¦ä¹ " â†’ ["ä»Šå¤©", "å­¦ä¹ ", "äº†", "æœºå™¨å­¦ä¹ "]

// 2. è¯é¢‘ç»Ÿè®¡
wordCounts[word] = (wordCounts[word] || 0) + 1;

// 3. TTRè®¡ç®— (è¯æ±‡ä¸°å¯Œåº¦)
const vocabDiversity = uniqueWords / totalWords;
// ä¾‹: 100ä¸ªç‹¬ç‰¹è¯æ±‡/500ä¸ªæ€»è¯æ±‡ = 0.2 (20%ä¸°å¯Œåº¦)

// 4. é«˜é¢‘è¯æå– (ç®€åŒ–TF-IDF)
const signatureWords = Object.entries(wordCounts)
  .map(([word, freq]) => ({
    word,
    frequency: freq,
    tfidf: freq * Math.log(tweets.length / 1)
  }));
```

### 2. å¥æ³•ç‰¹å¾åˆ†æ (Syntactic Features)

**ç›®æ ‡**: åˆ†æç”¨æˆ·çš„å¥å­ç»“æ„å’Œæ ‡ç‚¹ä½¿ç”¨ä¹ æƒ¯

**å…·ä½“æŒ‡æ ‡**:
```typescript
syntactic: {
  avgSentenceLength: number;           // å¹³å‡å¥é•¿
  sentenceTypeDistribution: {          // å¥å‹åˆ†å¸ƒ
    declarative: number;    // é™ˆè¿°å¥æ¯”ä¾‹
    interrogative: number;  // ç–‘é—®å¥æ¯”ä¾‹
    exclamatory: number;   // æ„Ÿå¹å¥æ¯”ä¾‹
    imperative: number;    // ç¥ˆä½¿å¥æ¯”ä¾‹
  };
  punctuationPattern: {               // æ ‡ç‚¹ä½¿ç”¨æ¨¡å¼
    exclamationDensity: number;  // æ„Ÿå¹å·å¯†åº¦
    questionDensity: number;     // é—®å·å¯†åº¦
    ellipsisDensity: number;     // çœç•¥å·å¯†åº¦
  };
}
```

**å·¥ä½œæœºåˆ¶**:
```javascript
// 1. å¥å­åˆ†å‰²
const sentences = cleanedText.split(/[ã€‚ï¼ï¼Ÿ\n]/).filter(s => s.trim().length > 0);

// 2. å¥å‹åˆ†ç±»
sentences.forEach(sentence => {
  if (sentence.includes('ï¼Ÿ') || /å—|å‘¢|ä¹ˆ/.test(sentence)) {
    sentenceTypes.interrogative++;      // ç–‘é—®å¥
  } else if (sentence.includes('ï¼')) {
    sentenceTypes.exclamatory++;        // æ„Ÿå¹å¥
  } else if (/^(è¯·|è®©|è¦|åˆ«)/.test(sentence)) {
    sentenceTypes.imperative++;         // ç¥ˆä½¿å¥
  } else {
    sentenceTypes.declarative++;        // é™ˆè¿°å¥
  }
});

// 3. æ ‡ç‚¹å¯†åº¦è®¡ç®—
punctuationCounts.exclamation += (tweet.content.match(/ï¼/g) || []).length;
const exclamationDensity = punctuationCounts.exclamation / tweets.length;
```

### 3. ç±»å‹é£æ ¼åˆ†æ (Type-Based Styles)

**ç›®æ ‡**: åˆ†æç”¨æˆ·åœ¨ä¸åŒæ¨æ–‡ç±»å‹ä¸‹çš„é£æ ¼å·®å¼‚

**å…·ä½“æŒ‡æ ‡**:
```typescript
typeBasedStyles: Record<string, {
  commonOpenings: string[];      // å¸¸ç”¨å¼€å¤´æ¨¡å¼
  commonClosings: string[];      // å¸¸ç”¨ç»“å°¾æ¨¡å¼
  avgLength: number;            // è¯¥ç±»å‹çš„å¹³å‡é•¿åº¦
  toneFeatures: Record<string, number>; // è¯­æ°”ç‰¹å¾
}>
```

**å·¥ä½œæœºåˆ¶**:
```javascript
// 1. è·å–ç”¨æˆ·çš„ç±»å‹æ ‡æ³¨æ•°æ®
const typeAnnotations = await db.tweetTypeAnnotation.findMany({
  where: { username },
  include: { tweet: true }
});

// 2. æŒ‰ç±»å‹åˆ†ç»„
typeAnnotations.forEach(annotation => {
  const types = JSON.parse(annotation.tweetTypes);
  Object.entries(types).forEach(([type, weight]) => {
    if (weight > 0.3) {  // åªè€ƒè™‘æƒé‡è¾ƒé«˜çš„ç±»å‹
      typeGroups[type].push({ content: annotation.tweet.content });
    }
  });
});

// 3. åˆ†ææ¯ä¸ªç±»å‹çš„ç‰¹å¾
Object.entries(typeGroups).forEach(([type, tweets]) => {
  // æå–å¼€å¤´æ¨¡å¼: "ä»Šå¤©å­¦ä¹ äº†..." â†’ "ä»Šå¤©å­¦ä¹ "
  const opening = content.substring(0, Math.min(10, content.length));

  // æå–ç»“å°¾æ¨¡å¼: "...å¾ˆæœ‰æ„æ€ï¼" â†’ "å¾ˆæœ‰æ„æ€ï¼"
  const closing = content.substring(Math.max(0, content.length - 10));

  // è¯­æ°”ç‰¹å¾åˆ†æ
  const toneFeatures = {
    enthusiasm: content.match(/[ï¼!]/g)?.length || 0,  // çƒ­æƒ…åº¦
    formality: content.length > 50 ? 0.1 : 0,         // æ­£å¼åº¦
    certainty: /ä¸€å®š|è‚¯å®š|ç¡®å®/.test(content) ? 0.2 : 0, // ç¡®å®šæ€§
  };
});
```

### 4. ä¸“ä¸šåº¦åˆ†æ (Professional Features)

**ç›®æ ‡**: è¯„ä¼°ç”¨æˆ·çš„ä¸“ä¸šçŸ¥è¯†æ°´å¹³å’Œè¡¨è¾¾é£æ ¼

**å…·ä½“æŒ‡æ ‡**:
```typescript
professional: {
  technicalTermUsage: number;        // æŠ€æœ¯æœ¯è¯­ä½¿ç”¨é¢‘ç‡
  dataCitationStyle: {               // æ•°æ®å¼•ç”¨é£æ ¼
    usesNumbers: boolean;            // æ˜¯å¦ä½¿ç”¨æ•°å­—
    citesPercentages: boolean;       // æ˜¯å¦å¼•ç”¨ç™¾åˆ†æ¯”
    mentionsStudies: boolean;        // æ˜¯å¦æåŠç ”ç©¶
  };
  industryKnowledgeLevel: 'basic' | 'intermediate' | 'expert';
}
```

**å·¥ä½œæœºåˆ¶**:
```javascript
// 1. æŠ€æœ¯æœ¯è¯­æ£€æµ‹
words.forEach(word => {
  if (/^(ç®—æ³•|æ•°æ®|æ¨¡å‹|ç³»ç»Ÿ|æ¶æ„|æ¡†æ¶|API|SDK|åˆ†æ|ä¼˜åŒ–|æ€§èƒ½)/.test(word)) {
    technicalTermCount++;
  }
});
const technicalTermUsage = technicalTermCount / totalWords;

// 2. å¼•ç”¨é£æ ¼æ£€æµ‹
if (/\d+%/.test(tweet.content)) {
  citationStyle.citesPercentages = true;    // "å‡†ç¡®ç‡æå‡äº†25%"
}
if (/ç ”ç©¶|æŠ¥å‘Š|è°ƒæŸ¥|æ•°æ®|æ˜¾ç¤º/.test(tweet.content)) {
  citationStyle.mentionsStudies = true;    // "ç ”ç©¶æ˜¾ç¤º"
}

// 3. çŸ¥è¯†æ°´å¹³åˆ¤æ–­
let industryKnowledgeLevel = 'basic';
if (technicalTermUsage > 0.1 && citationStyle.mentionsStudies) {
  industryKnowledgeLevel = 'expert';      // é«˜æŠ€æœ¯æœ¯è¯­ + å¼•ç”¨ç ”ç©¶
} else if (technicalTermUsage > 0.05 || citationStyle.usesNumbers) {
  industryKnowledgeLevel = 'intermediate'; // ä¸­ç­‰æŠ€æœ¯æœ¯è¯­æˆ–ä½¿ç”¨æ•°æ®
}
```

## ğŸ”„ å®Œæ•´çš„å­¦ä¹ æµç¨‹

### Phase 1: æ•°æ®è·å–
```javascript
// è·å–ç”¨æˆ·æ¨æ–‡æ•°æ® (æœ€å¤š500æ¡)
const tweets = await db.writingAnalysisTweet.findMany({
  where: { userUsername: username },
  select: { content: true },
  orderBy: { publishedAt: 'desc' },
  take: 500
});
```

### Phase 2: å¤šç»´åº¦åˆ†æ
```javascript
// å¹¶è¡Œåˆ†æå››ä¸ªç»´åº¦
const lexical = this.analyzeLexicalFeatures(tweets);
const syntactic = this.analyzeSyntacticFeatures(tweets);
const typeBasedStyles = await this.analyzeTypeBasedStyles(username);
const professional = this.analyzeProfessionalFeatures(tweets);
```

### Phase 3: é£æ ¼æ¡£æ¡ˆç”Ÿæˆ
```javascript
const styleFeatures = {
  lexical,           // è¯æ±‡ç‰¹å¾
  syntactic,         // å¥æ³•ç‰¹å¾
  typeBasedStyles,   // ç±»å‹é£æ ¼å·®å¼‚
  professional      // ä¸“ä¸šåº¦ç‰¹å¾
};
```

### Phase 4: æ•°æ®åº“å­˜å‚¨
```javascript
await db.userStyleProfile.upsert({
  where: { username },
  update: {
    signatureWords: JSON.stringify(styleFeatures.lexical.signatureWords),
    vocabDiversity: styleFeatures.lexical.vocabDiversity,
    avgSentenceLength: styleFeatures.syntactic.avgSentenceLength,
    // ... å…¶ä»–å­—æ®µ
    updatedAt: new Date()
  }
});
```

## ğŸ“± APIæ¥å£ä½¿ç”¨

### åˆ›å»ºé£æ ¼æ¡£æ¡ˆ
```bash
POST /api/writing-analysis/analyze-style
{
  "username": "@testuser",
  "forceUpdate": false
}
```

### è·å–é£æ ¼æ¡£æ¡ˆ
```bash
GET /api/writing-analysis/analyze-style?username=@testuser&detailed=true
```

**è¿”å›æ•°æ®ç»“æ„**:
```json
{
  "success": true,
  "data": {
    "username": "@testuser",
    "lastAnalyzedAt": "2024-01-01T00:00:00Z",
    "basicFeatures": {
      "vocabDiversity": 0.25,           // è¯æ±‡ä¸°å¯Œåº¦25%
      "wordComplexity": 2.3,           // å¹³å‡è¯é•¿2.3å­—ç¬¦
      "avgSentenceLength": 18.5,       // å¹³å‡å¥é•¿18.5å­—ç¬¦
      "technicalTermUsage": 0.08,      // æŠ€æœ¯æœ¯è¯­ä½¿ç”¨ç‡8%
      "industryKnowledgeLevel": "intermediate"
    },
    "detailedFeatures": {
      "signatureWords": [
        {"word": "æ•°æ®", "frequency": 15, "tfidf": 3.2},
        {"word": "åˆ†æ", "frequency": 12, "tfidf": 2.8}
      ],
      "sentenceTypeDist": {
        "declarative": 0.7,    // 70%é™ˆè¿°å¥
        "interrogative": 0.2,  // 20%ç–‘é—®å¥
        "exclamatory": 0.1     // 10%æ„Ÿå¹å¥
      },
      "tweetTypeStyles": {
        "ç ”ç©¶/æ•°æ®": {
          "commonOpenings": ["æ•°æ®æ˜¾ç¤º", "ç ”ç©¶è¡¨æ˜"],
          "avgLength": 45.2,
          "toneFeatures": {"formality": 0.8, "certainty": 0.6}
        }
      }
    }
  }
}
```

## ğŸ¯ å½“å‰ç³»ç»Ÿçš„ä¼˜åŠ¿ä¸é™åˆ¶

### âœ… ä¼˜åŠ¿
1. **å¤šç»´åº¦åˆ†æ**: ä»4ä¸ªä¸åŒè§’åº¦åˆ†æå†™ä½œé£æ ¼
2. **ç±»å‹å·®å¼‚**: èƒ½è¯†åˆ«ç”¨æˆ·åœ¨ä¸åŒæ¨æ–‡ç±»å‹ä¸‹çš„é£æ ¼å˜åŒ–
3. **é‡åŒ–æŒ‡æ ‡**: æä¾›å¯æ¯”è¾ƒçš„æ•°å€¼åŒ–ç‰¹å¾
4. **æ•°æ®æŒä¹…åŒ–**: é£æ ¼æ¡£æ¡ˆä¿å­˜åœ¨æ•°æ®åº“ä¸­

### âš ï¸ å½“å‰é™åˆ¶
1. **ç®€å•åˆ†è¯**: ä¾èµ–åŸºç¡€çš„æ–‡æœ¬åˆ†å‰²ï¼Œç²¾åº¦æœ‰é™
2. **è§„åˆ™é©±åŠ¨**: åŸºäºé¢„å®šä¹‰è§„åˆ™ï¼Œç¼ºä¹æ·±åº¦è¯­ä¹‰ç†è§£
3. **æ ·æœ¬ä¾èµ–**: éœ€è¦è¶³å¤Ÿçš„æ¨æ–‡æ•°æ®æ‰èƒ½å‡†ç¡®åˆ†æ
4. **é™æ€æ¨¡å¼**: æ— æ³•è¯†åˆ«é£æ ¼çš„æ—¶é—´æ¼”å˜

### ğŸš€ æ½œåœ¨æ”¹è¿›æ–¹å‘
1. **é›†æˆjiebaåˆ†è¯**: æé«˜è¯æ±‡è¯†åˆ«ç²¾åº¦
2. **è¯­ä¹‰åˆ†æ**: å¼•å…¥æƒ…æ„Ÿåˆ†æã€ä¸»é¢˜å»ºæ¨¡
3. **æ—¶é—´åºåˆ—**: è¿½è¸ªé£æ ¼å˜åŒ–è¶‹åŠ¿
4. **å¯¹æ¯”åˆ†æ**: ä¸å…¶ä»–ç”¨æˆ·é£æ ¼è¿›è¡Œæ¯”è¾ƒ

## ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯

è¿™ä¸ªé£æ ¼å­¦ä¹ æ¨¡å—ä¸ºåç»­çš„**æ¨æ–‡ç”Ÿæˆ**åŠŸèƒ½æä¾›åŸºç¡€ï¼š

1. **è¯æ±‡é€‰æ‹©**: æ ¹æ®ç”¨æˆ·å¸¸ç”¨è¯æ±‡ç”Ÿæˆç›¸ä¼¼çš„è¡¨è¾¾
2. **å¥å¼æ¨¡ä»¿**: æ¨¡æ‹Ÿç”¨æˆ·çš„å¥é•¿å’Œå¥å‹åå¥½
3. **è¯­æ°”åŒ¹é…**: ä¿æŒç”¨æˆ·çš„è¯­æ°”ç‰¹å¾(æ­£å¼/éšæ„/çƒ­æƒ…ç­‰)
4. **ç±»å‹é€‚é…**: é’ˆå¯¹ä¸åŒæ¨æ–‡ç±»å‹é‡‡ç”¨ç›¸åº”çš„é£æ ¼

å½“å‰çš„ç³»ç»Ÿå·²ç»èƒ½å¤Ÿæœ‰æ•ˆå­¦ä¹ å’Œå»ºæ¨¡ç”¨æˆ·çš„å†™ä½œé£æ ¼ï¼Œä¸ºä¸ªæ€§åŒ–å†…å®¹ç”Ÿæˆå¥ å®šäº†è‰¯å¥½åŸºç¡€ï¼