# å†™ä½œè¾…åŠ©æ¨¡å—åŠŸèƒ½å®Œå–„æ–¹æ¡ˆ

## 1. ä¸‰é˜¶æ®µç”Ÿæˆæœºåˆ¶

### 1.1 æ•°æ®åº“ç»“æ„æ‰©å±•

#### A. æ‰©å±• ArticleGenerationResult è¡¨
```sql
-- æ–°å¢å­—æ®µ
ALTER TABLE ArticleGenerationResult ADD COLUMN generationStage TEXT DEFAULT 'final'; -- 'outline', 'draft', 'final'
ALTER TABLE ArticleGenerationResult ADD COLUMN outlineContent TEXT; -- å¤§çº²å†…å®¹
ALTER TABLE ArticleGenerationResult ADD COLUMN draftContent TEXT; -- åˆç¨¿å†…å®¹
ALTER TABLE ArticleGenerationResult ADD COLUMN finalContent TEXT; -- æœ€ç»ˆå†…å®¹ï¼ˆåŸ generatedContentï¼‰
ALTER TABLE ArticleGenerationResult ADD COLUMN selfReviewNotes TEXT; -- è‡ªæŸ¥ä¼˜åŒ–è¯´æ˜
ALTER TABLE ArticleGenerationResult ADD COLUMN stageTokens TEXT; -- å„é˜¶æ®µtokenæ¶ˆè€— JSONæ ¼å¼

-- ç”¨æˆ·åé¦ˆå­—æ®µ
ALTER TABLE ArticleGenerationResult ADD COLUMN userRating INTEGER; -- 1-5è¯„åˆ†
ALTER TABLE ArticleGenerationResult ADD COLUMN userFeedback TEXT; -- å…·ä½“åé¦ˆæ–‡æœ¬
ALTER TABLE ArticleGenerationResult ADD COLUMN feedbackTags TEXT; -- JSONæ ¼å¼çš„åé¦ˆæ ‡ç­¾
ALTER TABLE ArticleGenerationResult ADD COLUMN adjustmentTarget TEXT; -- 'overview' | 'profile'
ALTER TABLE ArticleGenerationResult ADD COLUMN isImproved BOOLEAN DEFAULT FALSE; -- æ˜¯å¦å·²æ”¹è¿›
```

#### B. æ–°å¢åé¦ˆæ¨¡å¼è¡¨
```sql
CREATE TABLE FeedbackPattern (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL,
  contentType TEXT NOT NULL,
  feedbackType TEXT, -- 'negative', 'positive', 'suggestion'
  pattern TEXT, -- å…·ä½“é—®é¢˜æ¨¡å¼ï¼Œå¦‚"å¤ªä¹¦é¢åŒ–"ã€"è¡¨è¾¾ä¸å¤Ÿå£è¯­åŒ–"
  frequency INTEGER DEFAULT 1, -- å‡ºç°é¢‘æ¬¡
  lastOccurred DATETIME,
  isResolved BOOLEAN DEFAULT FALSE,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_feedback_pattern_user ON FeedbackPattern(username, contentType);
CREATE INDEX idx_feedback_pattern_type ON FeedbackPattern(feedbackType, isResolved);
```

### 1.2 ä¸‰é˜¶æ®µç”Ÿæˆæµç¨‹

#### é˜¶æ®µ1: å†…å®¹ç±»å‹åŒ–å¤§çº²ç”Ÿæˆ (Outline)

##### A. å†…å®¹ç±»å‹å¤§çº²æ¨¡æ¿
```typescript
interface OutlineTemplate {
  contentType: string;
  category: string;
  structure: OutlineSection[];
  tone: string;
  keyElements: string[];
  avoidElements?: string[];
}

interface OutlineSection {
  name: string;
  purpose: string;
  suggestedLength?: string;
  keyPoints: string[];
  optional?: boolean;
}

// å†…å®¹ç±»å‹å¤§çº²æ¨¡æ¿é…ç½®
export const OUTLINE_TEMPLATES: Record<TweetType, OutlineTemplate> = {
  // å†…å®¹å¯¼å‘ç±»
  'æ–°é—»/äº‹ä»¶': {
    contentType: 'æ–°é—»/äº‹ä»¶',
    category: 'å†…å®¹å¯¼å‘ç±»',
    tone: 'objective',
    keyElements: ['æ—¶æ•ˆæ€§', 'å‡†ç¡®æ€§', 'å®¢è§‚æ€§'],
    structure: [
      {
        name: 'æ ¸å¿ƒäº‹ä»¶',
        purpose: 'ç®€æ˜æ‰¼è¦åœ°æè¿°å‘ç”Ÿäº†ä»€ä¹ˆ',
        suggestedLength: '1-2å¥',
        keyPoints: ['æ—¶é—´è¦ç´ ', 'å…³é”®å½“äº‹äºº', 'æ ¸å¿ƒäº‹å®']
      },
      {
        name: 'èƒŒæ™¯ä¿¡æ¯',
        purpose: 'æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯',
        keyPoints: ['ç›¸å…³èƒŒæ™¯', 'å½±å“èŒƒå›´', 'é‡è¦æ€§è¯´æ˜']
      },
      {
        name: 'åç»­å‘å±•',
        purpose: 'è¯´æ˜å¯èƒ½çš„å½±å“æˆ–åç»­åŠ¨æ€',
        keyPoints: ['æ½œåœ¨å½±å“', 'å…³æ³¨è¦ç‚¹'],
        optional: true
      }
    ]
  },

  'ç ”ç©¶/æ•°æ®': {
    contentType: 'ç ”ç©¶/æ•°æ®',
    category: 'å†…å®¹å¯¼å‘ç±»',
    tone: 'analytical',
    keyElements: ['æ•°æ®å‡†ç¡®', 'åˆ†æå®¢è§‚', 'ç»“è®ºå¯ä¿¡'],
    structure: [
      {
        name: 'ç ”ç©¶èƒŒæ™¯',
        purpose: 'ä»‹ç»ç ”ç©¶çš„èƒŒæ™¯å’Œé‡è¦æ€§',
        keyPoints: ['ç ”ç©¶é—®é¢˜', 'æ•°æ®æ¥æº', 'ç ”ç©¶æ„ä¹‰']
      },
      {
        name: 'æ ¸å¿ƒå‘ç°',
        purpose: 'å±•ç¤ºå…³é”®æ•°æ®å’Œç ”ç©¶ç»“æœ',
        keyPoints: ['å…³é”®æ•°æ®', 'ç»Ÿè®¡ç»“æœ', 'è¶‹åŠ¿å˜åŒ–']
      },
      {
        name: 'æ·±åº¦åˆ†æ',
        purpose: 'è§£è¯»æ•°æ®èƒŒåçš„åŸå› å’Œæ„ä¹‰',
        keyPoints: ['åŸå› åˆ†æ', 'å½±å“è¯„ä¼°', 'å¯¹æ¯”å‚ç…§']
      },
      {
        name: 'ç»“è®ºå¯ç¤º',
        purpose: 'æ€»ç»“ç ”ç©¶ç»“è®ºå’Œå®é™…åº”ç”¨',
        keyPoints: ['æ ¸å¿ƒç»“è®º', 'å®é™…æ„ä¹‰', 'æœªæ¥é¢„æµ‹'],
        optional: true
      }
    ]
  },

  'ç§‘æ™®': {
    contentType: 'ç§‘æ™®',
    category: 'å†…å®¹å¯¼å‘ç±»',
    tone: 'educational',
    keyElements: ['é€šä¿—æ˜“æ‡‚', 'é€»è¾‘æ¸…æ™°', 'ç”ŸåŠ¨æœ‰è¶£'],
    structure: [
      {
        name: 'å¼•å…¥é—®é¢˜',
        purpose: 'å¼•å‡ºè¦ç§‘æ™®çš„æ¦‚å¿µæˆ–ç°è±¡',
        keyPoints: ['æ—¥å¸¸åœºæ™¯', 'å¼•å‘å¥½å¥‡', 'æå‡ºé—®é¢˜']
      },
      {
        name: 'æ ¸å¿ƒè§£é‡Š',
        purpose: 'ç”¨é€šä¿—è¯­è¨€è§£é‡Šæ ¸å¿ƒæ¦‚å¿µ',
        keyPoints: ['åŸºæœ¬åŸç†', 'ç®€å•ç±»æ¯”', 'å…³é”®æœºåˆ¶']
      },
      {
        name: 'å®ä¾‹éªŒè¯',
        purpose: 'é€šè¿‡å…·ä½“ä¾‹å­åŠ æ·±ç†è§£',
        keyPoints: ['ç”Ÿæ´»å®ä¾‹', 'åº”ç”¨åœºæ™¯', 'éªŒè¯è¯´æ˜']
      },
      {
        name: 'æ€»ç»“å»¶ä¼¸',
        purpose: 'æ€»ç»“è¦ç‚¹å¹¶å¼•å‘è¿›ä¸€æ­¥æ€è€ƒ',
        keyPoints: ['å…³é”®æ€»ç»“', 'å»¶ä¼¸æ€è€ƒ'],
        optional: true
      }
    ]
  },

  'æ•™ç¨‹/æŠ€å·§': {
    contentType: 'æ•™ç¨‹/æŠ€å·§',
    category: 'å†…å®¹å¯¼å‘ç±»',
    tone: 'instructional',
    keyElements: ['æ­¥éª¤æ¸…æ™°', 'å®ç”¨æ€§å¼º', 'æ˜“äºæ“ä½œ'],
    structure: [
      {
        name: 'é—®é¢˜åœºæ™¯',
        purpose: 'æè¿°è¦è§£å†³çš„é—®é¢˜æˆ–éœ€æ±‚',
        keyPoints: ['å…·ä½“åœºæ™¯', 'ç—›ç‚¹æè¿°', 'è§£å†³å¿…è¦æ€§']
      },
      {
        name: 'è§£å†³æ–¹æ¡ˆ',
        purpose: 'æä¾›å…·ä½“çš„æ“ä½œæ­¥éª¤æˆ–æ–¹æ³•',
        keyPoints: ['æ­¥éª¤åˆ†è§£', 'å…³é”®è¦ç‚¹', 'æ³¨æ„äº‹é¡¹']
      },
      {
        name: 'æ•ˆæœå±•ç¤º',
        purpose: 'è¯´æ˜é¢„æœŸæ•ˆæœå’ŒéªŒè¯æ–¹æ³•',
        keyPoints: ['é¢„æœŸç»“æœ', 'æˆåŠŸæ ‡å¿—', 'å¸¸è§é—®é¢˜']
      },
      {
        name: 'è¿›é˜¶æå‡',
        purpose: 'æä¾›æ›´æ·±å…¥çš„æŠ€å·§æˆ–ç›¸å…³å»ºè®®',
        keyPoints: ['è¿›é˜¶æŠ€å·§', 'ç›¸å…³å·¥å…·', 'å»¶ä¼¸å­¦ä¹ '],
        optional: true
      }
    ]
  },

  // è§‚ç‚¹è¡¨è¾¾ç±»
  'æ—¶äº‹è¯„è®º': {
    contentType: 'æ—¶äº‹è¯„è®º',
    category: 'è§‚ç‚¹è¡¨è¾¾ç±»',
    tone: 'opinionated',
    keyElements: ['è§‚ç‚¹é²œæ˜', 'é€»è¾‘ä¸¥å¯†', 'æœ‰ç†æœ‰æ®'],
    structure: [
      {
        name: 'äº‹ä»¶æ¦‚è¿°',
        purpose: 'ç®€è¦ä»‹ç»è¯„è®ºçš„äº‹ä»¶æˆ–ç°è±¡',
        keyPoints: ['å…³é”®äº‹å®', 'äº‰è®®ç„¦ç‚¹', 'ç¤¾ä¼šå…³æ³¨åº¦']
      },
      {
        name: 'ä¸ªäººè§‚ç‚¹',
        purpose: 'æ˜ç¡®è¡¨è¾¾è‡ªå·±çš„ç«‹åœºå’Œçœ‹æ³•',
        keyPoints: ['æ ¸å¿ƒè§‚ç‚¹', 'åˆ¤æ–­ä¾æ®', 'ä»·å€¼ç«‹åœº']
      },
      {
        name: 'è®ºè¯åˆ†æ',
        purpose: 'ç”¨é€»è¾‘å’Œäº‹å®æ”¯æ’‘è§‚ç‚¹',
        keyPoints: ['é€»è¾‘æ¨ç†', 'äº‹å®æ”¯æ’‘', 'åé¢è®ºè¯']
      },
      {
        name: 'æ€»ç»“å‘¼å',
        purpose: 'æ€»ç»“è§‚ç‚¹å¹¶æå‡ºå»ºè®®æˆ–å‘¼å',
        keyPoints: ['è§‚ç‚¹æ€»ç»“', 'è¡ŒåŠ¨å»ºè®®', 'æœªæ¥å±•æœ›'],
        optional: true
      }
    ]
  },

  'æ´è§/è§‚ç‚¹/è§‚å¯Ÿ': {
    contentType: 'æ´è§/è§‚ç‚¹/è§‚å¯Ÿ',
    category: 'è§‚ç‚¹è¡¨è¾¾ç±»',
    tone: 'reflective',
    keyElements: ['æ·±åº¦æ€è€ƒ', 'ç‹¬ç‰¹è§†è§’', 'å¯å‘æ€§'],
    structure: [
      {
        name: 'ç°è±¡è§‚å¯Ÿ',
        purpose: 'æè¿°è§‚å¯Ÿåˆ°çš„ç°è±¡æˆ–è¶‹åŠ¿',
        keyPoints: ['å…·ä½“ç°è±¡', 'è§‚å¯Ÿç»†èŠ‚', 'æ™®éæ€§']
      },
      {
        name: 'æ·±å±‚æ´å¯Ÿ',
        purpose: 'æå‡ºç‹¬ç‰¹çš„è§è§£å’Œæ€è€ƒ',
        keyPoints: ['æœ¬è´¨åˆ†æ', 'å†…åœ¨é€»è¾‘', 'æ·±å±‚åŸå› ']
      },
      {
        name: 'å¯å‘æ€è€ƒ',
        purpose: 'å¼•å‘è¯»è€…è¿›ä¸€æ­¥çš„æ€è€ƒ',
        keyPoints: ['æ€è€ƒæ–¹å‘', 'ç›¸å…³è”æƒ³', 'ä»·å€¼æ„ä¹‰']
      },
      {
        name: 'è§‚ç‚¹å»¶ä¼¸',
        purpose: 'å°†æ´å¯Ÿæ‰©å±•åˆ°æ›´å¹¿é˜”çš„å±‚é¢',
        keyPoints: ['æ™®éè§„å¾‹', 'ç±»æ¯”æ€è€ƒ', 'æœªæ¥è¶‹åŠ¿'],
        optional: true
      }
    ]
  },

  'ä»·å€¼è§‚è¡¨è¾¾': {
    contentType: 'ä»·å€¼è§‚è¡¨è¾¾',
    category: 'è§‚ç‚¹è¡¨è¾¾ç±»',
    tone: 'philosophical',
    keyElements: ['ç†å¿µæ˜ç¡®', 'ä»·å€¼åšæŒ', 'äººç”Ÿæ™ºæ…§'],
    structure: [
      {
        name: 'ä»·å€¼è§¦å‘',
        purpose: 'æè¿°å¼•å‘ä»·å€¼è§‚æ€è€ƒçš„äº‹ä»¶æˆ–æƒ…å¢ƒ',
        keyPoints: ['è§¦å‘äº‹ä»¶', 'å†…å¿ƒæ„Ÿå—', 'ä»·å€¼å†²çª']
      },
      {
        name: 'ç†å¿µé˜è¿°',
        purpose: 'æ˜ç¡®è¡¨è¾¾è‡ªå·±çš„ä»·å€¼è§‚å’Œäººç”Ÿç†å¿µ',
        keyPoints: ['æ ¸å¿ƒç†å¿µ', 'ä»·å€¼æ ‡å‡†', 'äººç”ŸåŸåˆ™']
      },
      {
        name: 'æ„ä¹‰è¯ é‡Š',
        purpose: 'è§£é‡Šè¿™ç§ä»·å€¼è§‚çš„æ„ä¹‰å’Œé‡è¦æ€§',
        keyPoints: ['ä»·å€¼æ„ä¹‰', 'äººç”ŸæŒ‡å¯¼', 'é€‰æ‹©æ ‡å‡†']
      },
      {
        name: 'è¡ŒåŠ¨ä½“ç°',
        purpose: 'è¯´æ˜å¦‚ä½•åœ¨å®é™…ç”Ÿæ´»ä¸­è·µè¡Œè¿™ç§ä»·å€¼è§‚',
        keyPoints: ['å…·ä½“è¡ŒåŠ¨', 'ç”Ÿæ´»ä½“ç°', 'åšæŒæ–¹å¼'],
        optional: true
      }
    ]
  },

  // ç”Ÿæ´»æƒ…æ„Ÿç±»
  'æ—¥å¸¸ç”Ÿæ´»': {
    contentType: 'æ—¥å¸¸ç”Ÿæ´»',
    category: 'ç”Ÿæ´»æƒ…æ„Ÿç±»',
    tone: 'casual',
    keyElements: ['çœŸå®è‡ªç„¶', 'ç”Ÿæ´»åŒ–', 'è½»æ¾æ„‰å¿«'],
    avoidElements: ['è¯´æ•™', 'å¤æ‚è®ºè¯', 'ä¸“ä¸šæœ¯è¯­'],
    structure: [
      {
        name: 'ç”Ÿæ´»åœºæ™¯',
        purpose: 'æè¿°å…·ä½“çš„ç”Ÿæ´»æƒ…å¢ƒæˆ–ç»å†',
        keyPoints: ['æ—¶é—´åœ°ç‚¹', 'å…·ä½“æ´»åŠ¨', 'äººç‰©äº’åŠ¨']
      },
      {
        name: 'æ„Ÿå—åˆ†äº«',
        purpose: 'è¡¨è¾¾ä¸ªäººçš„æ„Ÿå—å’Œä½“éªŒ',
        keyPoints: ['ç›´æ¥æ„Ÿå—', 'æƒ…ç»ªçŠ¶æ€', 'æœ‰è¶£ç»†èŠ‚']
      },
      {
        name: 'ç®€å•æ€»ç»“',
        purpose: 'è½»æ¾ç»“å°¾ï¼Œå¯èƒ½å¼•å‘å…±é¸£',
        keyPoints: ['ç®€å•æ„Ÿæ…¨', 'ç”Ÿæ´»æ„Ÿæ‚Ÿ', 'è½»æ¾è°ƒä¾ƒ'],
        optional: true
      }
    ]
  },

  'å¿ƒæƒ…è¡¨è¾¾': {
    contentType: 'å¿ƒæƒ…è¡¨è¾¾',
    category: 'ç”Ÿæ´»æƒ…æ„Ÿç±»',
    tone: 'emotional',
    keyElements: ['æƒ…æ„ŸçœŸæŒš', 'è¡¨è¾¾ç›´æ¥', 'å¼•å‘å…±é¸£'],
    structure: [
      {
        name: 'æƒ…ç»ªçŠ¶æ€',
        purpose: 'ç›´æ¥è¡¨è¾¾å½“å‰çš„å¿ƒæƒ…æˆ–æƒ…æ„Ÿ',
        keyPoints: ['æƒ…ç»ªè¯æ±‡', 'å¼ºåº¦è¡¨è¾¾', 'æƒ…æ„Ÿè‰²å½©']
      },
      {
        name: 'åŸå› èƒŒæ™¯',
        purpose: 'è¯´æ˜äº§ç”Ÿè¿™ç§æƒ…ç»ªçš„åŸå› ',
        keyPoints: ['è§¦å‘äº‹ä»¶', 'å…·ä½“æƒ…å¢ƒ', 'ä¸ªäººç»å†']
      },
      {
        name: 'æƒ…æ„Ÿå…±é¸£',
        purpose: 'å¯»æ±‚ç†è§£æˆ–å¼•å‘è¯»è€…å…±é¸£',
        keyPoints: ['é€šç”¨ç»å†', 'æƒ…æ„Ÿè¿æ¥', 'äº’åŠ¨é‚€è¯·'],
        optional: true
      }
    ]
  },

  'ä¸ªäººç»å†/æˆé•¿': {
    contentType: 'ä¸ªäººç»å†/æˆé•¿',
    category: 'ç”Ÿæ´»æƒ…æ„Ÿç±»',
    tone: 'reflective',
    keyElements: ['çœŸå®ç»å†', 'æˆé•¿æ„Ÿæ‚Ÿ', 'äººç”Ÿå¯ç¤º'],
    structure: [
      {
        name: 'ç»å†æè¿°',
        purpose: 'è¯¦ç»†æè¿°å…·ä½“çš„ä¸ªäººç»å†',
        keyPoints: ['äº‹ä»¶ç»è¿‡', 'å…³é”®è½¬æŠ˜', 'å½“æ—¶æ„Ÿå—']
      },
      {
        name: 'æˆé•¿æ„Ÿæ‚Ÿ',
        purpose: 'åˆ†äº«ä»ç»å†ä¸­è·å¾—çš„æ„Ÿæ‚Ÿå’Œæˆé•¿',
        keyPoints: ['é‡è¦é¢†æ‚Ÿ', 'æ€ç»´å˜åŒ–', 'èƒ½åŠ›æå‡']
      },
      {
        name: 'ä»·å€¼å¯ç¤º',
        purpose: 'æ€»ç»“ç»å†å¸¦æ¥çš„äººç”Ÿå¯ç¤º',
        keyPoints: ['äººç”Ÿé“ç†', 'ä»·å€¼å‘ç°', 'æœªæ¥æŒ‡å¯¼']
      },
      {
        name: 'ç»éªŒåˆ†äº«',
        purpose: 'ä¸ºä»–äººæä¾›å¯å€Ÿé‰´çš„ç»éªŒ',
        keyPoints: ['å®ç”¨å»ºè®®', 'é¿å‘æŒ‡å—', 'æˆé•¿è·¯å¾„'],
        optional: true
      }
    ]
  },

  // äº’åŠ¨ä¼ æ’­ç±»
  'èµ„æºåˆ†äº«': {
    contentType: 'èµ„æºåˆ†äº«',
    category: 'äº’åŠ¨ä¼ æ’­ç±»',
    tone: 'sharing',
    keyElements: ['å®ç”¨ä»·å€¼', 'ä½¿ç”¨ä½“éªŒ', 'æ¨èç†ç”±'],
    structure: [
      {
        name: 'èµ„æºä»‹ç»',
        purpose: 'ç®€è¦ä»‹ç»è¦åˆ†äº«çš„èµ„æº',
        keyPoints: ['èµ„æºç±»å‹', 'åŸºæœ¬ä¿¡æ¯', 'è·å–æ–¹å¼']
      },
      {
        name: 'ä½¿ç”¨ä½“éªŒ',
        purpose: 'åˆ†äº«ä¸ªäººä½¿ç”¨æ„Ÿå—å’Œæ•ˆæœ',
        keyPoints: ['ä½¿ç”¨åœºæ™¯', 'å®é™…æ•ˆæœ', 'ä¼˜ç¼ºç‚¹è¯„ä»·']
      },
      {
        name: 'æ¨èå»ºè®®',
        purpose: 'ç»™å‡ºä½¿ç”¨å»ºè®®å’Œæ¨èç†ç”±',
        keyPoints: ['é€‚ç”¨äººç¾¤', 'ä½¿ç”¨æŠ€å·§', 'æ¨èæŒ‡æ•°']
      },
      {
        name: 'å»¶ä¼¸æ¨è',
        purpose: 'æ¨èç›¸å…³çš„å…¶ä»–ä¼˜è´¨èµ„æº',
        keyPoints: ['ç±»ä¼¼èµ„æº', 'é…å¥—å·¥å…·', 'è¿›é˜¶é€‰æ‹©'],
        optional: true
      }
    ]
  },

  'äº’åŠ¨è¯é¢˜': {
    contentType: 'äº’åŠ¨è¯é¢˜',
    category: 'äº’åŠ¨ä¼ æ’­ç±»',
    tone: 'interactive',
    keyElements: ['è¯é¢˜æ€§å¼º', 'å¼•å‘è®¨è®º', 'äº’åŠ¨å‹å¥½'],
    structure: [
      {
        name: 'è¯é¢˜å¼•å…¥',
        purpose: 'æå‡ºæœ‰è¶£æˆ–æœ‰äº‰è®®çš„è¯é¢˜',
        keyPoints: ['è¯é¢˜èƒŒæ™¯', 'å¼•å‘ç‚¹', 'å…³æ³¨åº¦']
      },
      {
        name: 'è§‚ç‚¹å±•ç¤º',
        purpose: 'å±•ç¤ºä¸åŒçš„è§‚ç‚¹æˆ–é€‰æ‹©',
        keyPoints: ['å¤šå…ƒè§‚ç‚¹', 'åˆ©å¼Šåˆ†æ', 'é€‰æ‹©å›°å¢ƒ']
      },
      {
        name: 'äº’åŠ¨é‚€è¯·',
        purpose: 'æ˜ç¡®é‚€è¯·è¯»è€…å‚ä¸è®¨è®º',
        keyPoints: ['é—®é¢˜æŠ›å‡º', 'æŠ•ç¥¨é€‰æ‹©', 'ç»éªŒå¾é›†']
      },
      {
        name: 'è®¨è®ºå¼•å¯¼',
        purpose: 'å¼•å¯¼è®¨è®ºå‘æ›´æ·±å±‚æ¬¡å‘å±•',
        keyPoints: ['æ·±åº¦é—®é¢˜', 'æ€è€ƒè§’åº¦', 'ä»·å€¼æ¢è®¨'],
        optional: true
      }
    ]
  },

  'æç¬‘': {
    contentType: 'æç¬‘',
    category: 'äº’åŠ¨ä¼ æ’­ç±»',
    tone: 'humorous',
    keyElements: ['å¹½é»˜æ„Ÿ', 'è½»æ¾æœ‰è¶£', 'å¼•å‘ç¬‘ç‚¹'],
    avoidElements: ['ä¸¥è‚ƒè¯´æ•™', 'å¤æ‚é€»è¾‘', 'æ²‰é‡è¯é¢˜'],
    structure: [
      {
        name: 'è®¾ç½®é“ºå«',
        purpose: 'è¥é€ å¹½é»˜çš„æƒ…å¢ƒæˆ–èƒŒæ™¯',
        keyPoints: ['åœºæ™¯è®¾å®š', 'äººç‰©å…³ç³»', 'é¢„æœŸè¥é€ ']
      },
      {
        name: 'ç¬‘ç‚¹çˆ†å‘',
        purpose: 'åˆ¶é€ åè½¬æˆ–å¹½é»˜çš„é«˜æ½®',
        keyPoints: ['æ„å¤–åè½¬', 'å¤¸å¼ è¡¨ç°', 'å¯¹æ¯”æ•ˆæœ']
      },
      {
        name: 'ä½™éŸµå»¶ç»­',
        purpose: 'å»¶ç»­å¹½é»˜æ•ˆæœæˆ–å¼•å‘äº’åŠ¨',
        keyPoints: ['å¹½é»˜æ€»ç»“', 'äº’åŠ¨é‚€è¯·', 'åç»­è°ƒä¾ƒ'],
        optional: true
      }
    ]
  }
};
```

##### B. æ™ºèƒ½å¤§çº²ç”Ÿæˆå™¨
```typescript
export class ContentTypeOutlineGenerator {

  async generateOutline(task: ArticleGenerationTask): Promise<string> {
    const contentType = task.contentType as TweetType;
    const template = OUTLINE_TEMPLATES[contentType];

    if (!template) {
      return await this.generateGenericOutline(task);
    }

    const prompt = this.buildTypeSpecificPrompt(task, template);
    const config = await WritingAssistantConfigLoader.getAnalysisConfig();
    const aiService = AIServiceFactory.createService({
      provider: config.provider,
      model: config.model,
      apiKey: config.apiKey,
      baseURL: config.baseURL
    });

    return await aiService.generateText(prompt);
  }

  private buildTypeSpecificPrompt(task: ArticleGenerationTask, template: OutlineTemplate): string {
    let prompt = `è¯·ä¸º"${template.contentType}"ç±»å‹çš„å†…å®¹ç”Ÿæˆè¯¦ç»†å¤§çº²ï¼š

ä¸»é¢˜ï¼š${task.topic}
å¹³å°ï¼š${task.platform.name}
${task.platform.wordCount ? `å­—æ•°è¦æ±‚ï¼š${task.platform.wordCount}` : ''}

å†…å®¹ç±»å‹ç‰¹å¾ï¼š
- ç±»åˆ«ï¼š${template.category}
- è¯­è°ƒï¼š${template.tone}
- æ ¸å¿ƒè¦ç´ ï¼š${template.keyElements.join('ã€')}`;

    if (template.avoidElements) {
      prompt += `\n- é¿å…å…ƒç´ ï¼š${template.avoidElements.join('ã€')}`;
    }

    prompt += `\n\nè¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„æ¡†æ¶ç”Ÿæˆå¤§çº²ï¼š\n`;

    template.structure.forEach((section, index) => {
      prompt += `\n${index + 1}. ${section.name}${section.optional ? 'ï¼ˆå¯é€‰ï¼‰' : ''}
ç›®çš„ï¼š${section.purpose}
${section.suggestedLength ? `å»ºè®®é•¿åº¦ï¼š${section.suggestedLength}` : ''}
å…³é”®è¦ç‚¹ï¼š${section.keyPoints.join('ã€')}`;
    });

    prompt += `\n\nç”Ÿæˆè¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§${template.contentType}ç±»å‹çš„ç‰¹ç‚¹ç»„ç»‡å†…å®¹
2. ç¡®ä¿å¤§çº²é€»è¾‘æ¸…æ™°ã€å±‚æ¬¡åˆ†æ˜
3. æ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å…·ä½“çš„å†…å®¹è¦ç‚¹
4. ä¿æŒ${template.tone}çš„è¯­è°ƒç‰¹å¾
5. ä¸è¦ç”Ÿæˆå…·ä½“çš„æ­£æ–‡å†…å®¹ï¼Œåªç”Ÿæˆç»“æ„åŒ–çš„å¤§çº²

è¯·ç›´æ¥è¾“å‡ºå¤§çº²å†…å®¹ï¼š`;

    return prompt;
  }
}

// ä¿®æ”¹åŸæœ‰çš„ generateOutline å‡½æ•°
async function generateOutline(task: ArticleGenerationTask): Promise<string> {
  const generator = new ContentTypeOutlineGenerator();
  const validator = new OutlineValidator();

  // ç”Ÿæˆå¤§çº²
  let outline = await generator.generateOutline(task);

  // éªŒè¯å¤§çº²è´¨é‡
  if (task.contentType) {
    const validation = validator.validateOutline(outline, task.contentType as TweetType);

    if (!validation.isValid && validation.warnings.length > 0) {
      console.log(`å¤§çº²éªŒè¯è­¦å‘Š: ${validation.warnings.join(', ')}`);

      // å¦‚æœæœ‰ä¸¥é‡é—®é¢˜ï¼Œå°è¯•é‡æ–°ç”Ÿæˆ
      if (validation.warnings.length >= 2) {
        console.log('å°è¯•é‡æ–°ç”Ÿæˆå¤§çº²...');
        outline = await generator.generateOutline(task);
      }
    }
  }

  return outline;
}
```

##### C. å¤§çº²è´¨é‡éªŒè¯å™¨
```typescript
export class OutlineValidator {

  validateOutline(outline: string, contentType: TweetType): ValidationResult {
    const template = OUTLINE_TEMPLATES[contentType];
    if (!template) {
      return { isValid: true, warnings: [] };
    }

    const warnings: string[] = [];

    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ç»“æ„å…ƒç´ 
    const requiredSections = template.structure.filter(s => !s.optional);
    requiredSections.forEach(section => {
      if (!this.containsSection(outline, section)) {
        warnings.push(`ç¼ºå°‘å¿…è¦éƒ¨åˆ†ï¼š${section.name}`);
      }
    });

    // æ£€æŸ¥æ˜¯å¦åŒ…å«åº”é¿å…çš„å…ƒç´ 
    if (template.avoidElements) {
      template.avoidElements.forEach(element => {
        if (outline.toLowerCase().includes(element.toLowerCase())) {
          warnings.push(`åŒ…å«åº”é¿å…çš„å…ƒç´ ï¼š${element}`);
        }
      });
    }

    return {
      isValid: warnings.length === 0,
      warnings,
      suggestions: this.generateSuggestions(warnings, template)
    };
  }

  private containsSection(outline: string, section: OutlineSection): boolean {
    const sectionKeywords = [section.name, ...section.keyPoints];
    return sectionKeywords.some(keyword =>
      outline.toLowerCase().includes(keyword.toLowerCase())
    );
  }
}

interface ValidationResult {
  isValid: boolean;
  warnings: string[];
  suggestions?: string[];
}
```

#### é˜¶æ®µ2: åˆç¨¿æ‰©å±• (Draft)
```typescript
async function generateDraft(outline: string, task: ArticleGenerationTask): Promise<string> {
  const prompt = `åŸºäºä»¥ä¸‹å¤§çº²ï¼Œæ’°å†™å®Œæ•´çš„åˆç¨¿ï¼š

å¤§çº²ï¼š
${outline}

ä¸»é¢˜ï¼š${task.topic}
å¹³å°è¦æ±‚ï¼š${task.platform.name}
${task.platform.wordCount ? `å­—æ•°è¦æ±‚ï¼š${task.platform.wordCount}` : ''}

${task.username ? await buildDetailedStylePrompt(task.username, task.contentType) : ''}

æ’°å†™è¦æ±‚ï¼š
1. ä¸¥æ ¼æŒ‰ç…§å¤§çº²ç»“æ„å±•å¼€
2. ä¿æŒå†…å®¹çš„é€»è¾‘æ€§å’Œè¿è´¯æ€§
3. èå…¥ä¸ªäººå†™ä½œé£æ ¼
4. ç¡®ä¿å†…å®¹å……å®ä¸”æœ‰ä»·å€¼

è¯·æ’°å†™å®Œæ•´çš„æ–‡ç« å†…å®¹ï¼š`;

  return await callAI(prompt);
}
```

#### é˜¶æ®µ3: è‡ªæŸ¥ä¼˜åŒ– (Final)
```typescript
async function selfReviewAndOptimize(draft: string, task: ArticleGenerationTask): Promise<{content: string, reviewNotes: string}> {
  const prompt = `è¯·å¯¹ä»¥ä¸‹åˆç¨¿è¿›è¡Œè‡ªæŸ¥å’Œä¼˜åŒ–ï¼š

åˆç¨¿å†…å®¹ï¼š
${draft}

åŸå§‹è¦æ±‚ï¼š
- ä¸»é¢˜ï¼š${task.topic}
- å¹³å°ï¼š${task.platform.name}
- å­—æ•°è¦æ±‚ï¼š${task.platform.wordCount || 'é€‚ä¸­'}

${task.username ? `ç”¨æˆ·å†™ä½œé£æ ¼è¦æ±‚ï¼š${await getStyleSummary(task.username, task.contentType)}` : ''}

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œæ£€æŸ¥å’Œä¼˜åŒ–ï¼š
1. å†…å®¹å®Œæ•´æ€§ï¼šæ˜¯å¦å……åˆ†å›åº”ä¸»é¢˜
2. é€»è¾‘ç»“æ„ï¼šæ®µè½é—´çš„é€»è¾‘å…³ç³»æ˜¯å¦æ¸…æ™°
3. è¯­è¨€è¡¨è¾¾ï¼šæ˜¯å¦ç¬¦åˆå¹³å°ç‰¹è‰²å’Œç”¨æˆ·é£æ ¼
4. ä¿¡æ¯å¯†åº¦ï¼šå†…å®¹æ˜¯å¦å……å®æœ‰ä»·å€¼
5. è¯»è€…ä½“éªŒï¼šæ˜¯å¦æ˜“è¯»ä¸”æœ‰å¸å¼•åŠ›

è¿”å›JSONæ ¼å¼ï¼š
{
  "optimizedContent": "ä¼˜åŒ–åçš„å®Œæ•´å†…å®¹",
  "reviewNotes": "å…·ä½“ä¼˜åŒ–è¯´æ˜ï¼ŒåŒ…æ‹¬ä¿®æ”¹çš„åœ°æ–¹å’Œç†ç”±"
}`;

  const result = await callAI(prompt);
  const parsed = JSON.parse(result);
  return {
    content: parsed.optimizedContent,
    reviewNotes: parsed.reviewNotes
  };
}
```

### 1.3 ä¸‰é˜¶æ®µç”Ÿæˆä¸»æµç¨‹
```typescript
async function processThreeStageGeneration(taskId: string): Promise<void> {
  try {
    await updateTaskStatus(taskId, "processing");

    const task = await getTaskWithRelations(taskId);

    // é˜¶æ®µ1ï¼šå¤§çº²ç”Ÿæˆ
    console.log(`[${taskId}] å¼€å§‹ç”Ÿæˆå¤§çº²...`);
    const outline = await generateOutline(task);

    await saveGenerationResult(taskId, {
      stage: 'outline',
      content: outline,
      tokens: await calculateTokens(outline)
    });

    // é˜¶æ®µ2ï¼šåˆç¨¿æ‰©å±•
    console.log(`[${taskId}] åŸºäºå¤§çº²ç”Ÿæˆåˆç¨¿...`);
    const draft = await generateDraft(outline, task);

    await saveGenerationResult(taskId, {
      stage: 'draft',
      content: draft,
      tokens: await calculateTokens(draft)
    });

    // é˜¶æ®µ3ï¼šè‡ªæŸ¥ä¼˜åŒ–
    console.log(`[${taskId}] è¿›è¡Œè‡ªæŸ¥ä¼˜åŒ–...`);
    const { content: finalContent, reviewNotes } = await selfReviewAndOptimize(draft, task);

    await saveGenerationResult(taskId, {
      stage: 'final',
      content: finalContent,
      reviewNotes,
      tokens: await calculateTokens(finalContent)
    });

    await updateTaskStatus(taskId, "completed");
    console.log(`[${taskId}] ä¸‰é˜¶æ®µç”Ÿæˆå®Œæˆ`);

  } catch (error) {
    console.error(`ä¸‰é˜¶æ®µç”Ÿæˆå¤±è´¥ (ä»»åŠ¡ID: ${taskId}):`, error);
    await updateTaskStatus(taskId, "failed", error.message);
  }
}
```

## 2. ç”¨æˆ·åé¦ˆåŒå±‚è°ƒæ•´æœºåˆ¶

### 2.1 å‰ç«¯åé¦ˆç•Œé¢ç»„ä»¶

#### A. åé¦ˆæ”¶é›†è¡¨å•
```tsx
interface FeedbackFormProps {
  resultId: string;
  username: string;
  contentType: string;
  generatedContent: string;
  stage: 'outline' | 'draft' | 'final';
}

function FeedbackForm({ resultId, username, contentType, generatedContent, stage }: FeedbackFormProps) {
  const [rating, setRating] = useState(0);
  const [feedbackText, setFeedbackText] = useState('');
  const [selectedTags, setSelectedTags] = useState<string[]>([]);
  const [adjustmentTarget, setAdjustmentTarget] = useState<'overview' | 'profile'>('profile');

  const commonFeedbackTags = [
    'å¤ªä¹¦é¢åŒ–', 'ä¸å¤Ÿå£è¯­åŒ–', 'è¯­è°ƒè¿‡äºä¸¥è‚ƒ', 'ç¼ºä¹ä¸ªäººç‰¹è‰²',
    'å¼€å¤´è¿‡äºçªå…€', 'ç»“å°¾ä¸å¤Ÿæœ‰åŠ›', 'é€»è¾‘ä¸å¤Ÿæ¸…æ™°', 'å†…å®¹è¿‡äºæµ…æ˜¾',
    'ä¸“ä¸šæœ¯è¯­è¿‡å¤š', 'è¡¨è¾¾è¿‡äºå¤æ‚', 'è¯­è¨€è¿‡äºå¹³æ·¡', 'ç¼ºä¹äº’åŠ¨æ„Ÿ'
  ];

  return (
    <Card className="feedback-container">
      <CardHeader>
        <CardTitle>å†…å®¹åé¦ˆ - {stage === 'final' ? 'æœ€ç»ˆç‰ˆ' : stage === 'draft' ? 'åˆç¨¿' : 'å¤§çº²'}</CardTitle>
      </CardHeader>

      <CardContent className="space-y-6">
        {/* è¯„åˆ†ç»„ä»¶ */}
        <div>
          <Label>æ•´ä½“æ»¡æ„åº¦</Label>
          <StarRating value={rating} onChange={setRating} />
        </div>

        {/* å¿«é€Ÿæ ‡ç­¾é€‰æ‹© */}
        <div>
          <Label>å¸¸è§é—®é¢˜ï¼ˆå¯å¤šé€‰ï¼‰</Label>
          <div className="flex flex-wrap gap-2 mt-2">
            {commonFeedbackTags.map(tag => (
              <Badge
                key={tag}
                variant={selectedTags.includes(tag) ? "default" : "outline"}
                className="cursor-pointer"
                onClick={() => toggleTag(tag)}
              >
                {tag}
              </Badge>
            ))}
          </div>
        </div>

        {/* è¯¦ç»†åé¦ˆ */}
        <div>
          <Label>å…·ä½“å»ºè®®</Label>
          <Textarea
            placeholder="è¯·æè¿°å…·ä½“é—®é¢˜å’Œæ”¹è¿›å»ºè®®..."
            value={feedbackText}
            onChange={(e) => setFeedbackText(e.target.value)}
            rows={4}
          />
        </div>

        {/* è°ƒæ•´ç›®æ ‡é€‰æ‹© */}
        <div>
          <Label>åé¦ˆä½œç”¨èŒƒå›´</Label>
          <RadioGroup value={adjustmentTarget} onValueChange={setAdjustmentTarget}>
            <div className="space-y-3">
              <Label className="flex items-start space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                <RadioGroupItem value="profile" />
                <div>
                  <div className="font-medium">ç±»å‹åŒ–é£æ ¼è°ƒæ•´</div>
                  <div className="text-sm text-gray-600">åªå½±å“"{contentType}"ç±»å‹çš„å†™ä½œé£æ ¼</div>
                  <div className="text-xs text-gray-500">æ¨èç”¨äºï¼šç‰¹å®šå†…å®¹ç±»å‹çš„è¡¨è¾¾æ–¹å¼è°ƒæ•´</div>
                </div>
              </Label>

              <Label className="flex items-start space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                <RadioGroupItem value="overview" />
                <div>
                  <div className="font-medium">å…¨å±€é£æ ¼è°ƒæ•´</div>
                  <div className="text-sm text-gray-600">å½±å“æ‰€æœ‰å†…å®¹ç±»å‹çš„æ•´ä½“å†™ä½œé£æ ¼</div>
                  <div className="text-xs text-gray-500">æ¨èç”¨äºï¼šè¯­è¨€ä¹ æƒ¯ã€è¡¨è¾¾åå¥½ç­‰åŸºç¡€è°ƒæ•´</div>
                </div>
              </Label>
            </div>
          </RadioGroup>
        </div>

        {/* æ™ºèƒ½æ¨è */}
        <div className="bg-blue-50 p-3 rounded-lg">
          <div className="text-sm text-blue-800">
            ğŸ’¡ æ™ºèƒ½æ¨èï¼šåŸºäºæ‚¨çš„åé¦ˆå†…å®¹ï¼Œå»ºè®®é€‰æ‹©
            <strong>{getRecommendedTarget(feedbackText, selectedTags)}</strong>
          </div>
        </div>

        <Button onClick={submitFeedback} className="w-full">
          æäº¤åé¦ˆ
        </Button>
      </CardContent>
    </Card>
  );
}
```

#### B. ä¸‰é˜¶æ®µå†…å®¹å±•ç¤ºç»„ä»¶
```tsx
function GenerationStagesViewer({ resultId }: { resultId: string }) {
  const [result, setResult] = useState<ArticleGenerationResult | null>(null);
  const [activeStage, setActiveStage] = useState<'outline' | 'draft' | 'final'>('final');

  const stages = [
    { key: 'outline', label: 'å¤§çº²', content: result?.outlineContent },
    { key: 'draft', label: 'åˆç¨¿', content: result?.draftContent },
    { key: 'final', label: 'æœ€ç»ˆç‰ˆ', content: result?.finalContent }
  ];

  return (
    <div className="space-y-4">
      {/* é˜¶æ®µé€‰æ‹©æ ‡ç­¾ */}
      <Tabs value={activeStage} onValueChange={setActiveStage}>
        <TabsList className="grid w-full grid-cols-3">
          {stages.map(stage => (
            <TabsTrigger key={stage.key} value={stage.key}>
              {stage.label}
              {stage.content && <Badge variant="outline" className="ml-2">âœ“</Badge>}
            </TabsTrigger>
          ))}
        </TabsList>

        {stages.map(stage => (
          <TabsContent key={stage.key} value={stage.key}>
            <Card>
              <CardHeader>
                <CardTitle>{stage.label}</CardTitle>
                {stage.key === 'final' && result?.selfReviewNotes && (
                  <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                    <strong>è‡ªæŸ¥ä¼˜åŒ–è¯´æ˜ï¼š</strong>
                    <p>{result.selfReviewNotes}</p>
                  </div>
                )}
              </CardHeader>
              <CardContent>
                <div className="whitespace-pre-wrap">{stage.content}</div>
              </CardContent>
            </Card>

            {/* æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥åé¦ˆ */}
            <FeedbackForm
              resultId={resultId}
              username={result?.task.username}
              contentType={result?.task.contentType}
              generatedContent={stage.content}
              stage={stage.key}
            />
          </TabsContent>
        ))}
      </Tabs>
    </div>
  );
}
```

### 2.2 åé¦ˆå¤„ç†æœåŠ¡

#### A. åé¦ˆåˆ†æä¸è°ƒæ•´æœåŠ¡
```typescript
export class FeedbackAdjustmentService {

  async processFeedback(feedbackData: FeedbackSubmission): Promise<void> {
    // 1. ä¿å­˜åé¦ˆè®°å½•
    const feedback = await this.saveFeedbackRecord(feedbackData);

    // 2. åˆ†æåé¦ˆæ¨¡å¼
    await this.analyzeFeedbackPattern(feedback);

    // 3. æ‰§è¡Œç›¸åº”çš„è°ƒæ•´
    if (feedback.adjustmentTarget === 'overview') {
      await this.adjustUserWritingOverview(feedback);
    } else {
      await this.adjustUserStyleProfile(feedback);
    }

    // 4. è®°å½•å¤„ç†ç»“æœ
    await this.markFeedbackProcessed(feedback.id);
  }

  private async adjustUserWritingOverview(feedback: FeedbackRecord): Promise<void> {
    const currentOverview = await db.userWritingOverview.findUnique({
      where: { username: feedback.username }
    });

    if (!currentOverview) {
      throw new Error(`ç”¨æˆ· ${feedback.username} å°šæœªç”Ÿæˆå†™ä½œæ¦‚è§ˆ`);
    }

    const adjustmentPrompt = `
è¯·åŸºäºç”¨æˆ·åé¦ˆè°ƒæ•´å†™ä½œé£æ ¼æ¦‚è§ˆã€‚

å½“å‰æ¦‚è§ˆæ•°æ®ï¼š
${currentOverview.overviewContent}

ç”¨æˆ·åé¦ˆä¿¡æ¯ï¼š
- è¯„åˆ†ï¼š${feedback.rating}/5
- åé¦ˆæ ‡ç­¾ï¼š${feedback.feedbackTags}
- å…·ä½“é—®é¢˜ï¼š${feedback.feedbackText}
- ç”Ÿæˆé˜¶æ®µï¼š${feedback.stage}

åé¦ˆé’ˆå¯¹çš„å†…å®¹ï¼š
${feedback.targetContent}

è¯·åˆ†æåé¦ˆå¹¶è°ƒæ•´æ¦‚è§ˆä¸­çš„ç›¸å…³éƒ¨åˆ†ï¼š

1. å¦‚æœåé¦ˆæ¶‰åŠ"å¤ªä¹¦é¢åŒ–"ã€"è¯­è¨€ä¹ æƒ¯"ç­‰ï¼Œè°ƒæ•´ writingPersonality å’Œ toneCharacteristics
2. å¦‚æœåé¦ˆæ¶‰åŠ"å¼€å¤´çªå…€"ã€"ç»“å°¾æ— åŠ›"ç­‰ï¼Œè°ƒæ•´ typicalStructure ä¸­çš„å¼€å¤´ç»“å°¾æ¨¡å¼
3. å¦‚æœåé¦ˆæ¶‰åŠ"è¡¨è¾¾æ–¹å¼"ã€"å¥å¼"ç­‰ï¼Œè°ƒæ•´ typicalSentences éƒ¨åˆ†
4. å¦‚æœåé¦ˆæ¶‰åŠ"äº’åŠ¨æ„Ÿ"ã€"è¯­è°ƒ"ç­‰ï¼Œè°ƒæ•´ toneCharacteristics

è°ƒæ•´åŸåˆ™ï¼š
- ä¿æŒç”¨æˆ·æ ¸å¿ƒå†™ä½œç‰¹è‰²ï¼Œåªè°ƒæ•´æœ‰é—®é¢˜çš„éƒ¨åˆ†
- åŸºäºå…·ä½“åé¦ˆå†…å®¹è¿›è¡Œç²¾å‡†è°ƒæ•´
- ç¡®ä¿è°ƒæ•´åçš„æ¦‚è§ˆæ›´ç¬¦åˆç”¨æˆ·æœŸæœ›

è¿”å›å®Œæ•´çš„è°ƒæ•´åæ¦‚è§ˆJSONï¼Œä¿æŒåŸæœ‰æ•°æ®ç»“æ„ï¼š`;

    try {
      const config = await WritingAssistantConfigLoader.getAnalysisConfig();
      const aiService = AIServiceFactory.createService({
        provider: config.provider,
        model: config.model,
        apiKey: config.apiKey,
        baseURL: config.baseURL
      });

      const adjustedOverviewStr = await aiService.generateText(adjustmentPrompt);
      const adjustedOverview = JSON.parse(adjustedOverviewStr);

      // æ›´æ–°æ•°æ®åº“
      await db.userWritingOverview.update({
        where: { username: feedback.username },
        data: {
          overviewContent: JSON.stringify(adjustedOverview),
          lastUpdated: new Date(),
          version: { increment: 1 }
        }
      });

      // è®°å½•æ›´æ–°æ—¥å¿—
      await db.overviewUpdateLog.create({
        data: {
          username: feedback.username,
          updateType: 'FEEDBACK_ADJUSTMENT',
          changesMade: JSON.stringify({
            feedbackId: feedback.id,
            adjustmentSummary: `åŸºäºç”¨æˆ·åé¦ˆè°ƒæ•´å…¨å±€å†™ä½œé£æ ¼`,
            specificChanges: this.extractChanges(currentOverview.overviewContent, adjustedOverviewStr)
          }),
          llmModel: config.model
        }
      });

      console.log(`ç”¨æˆ· ${feedback.username} çš„å…¨å±€å†™ä½œé£æ ¼å·²æ ¹æ®åé¦ˆè°ƒæ•´`);

    } catch (error) {
      console.error('è°ƒæ•´å…¨å±€å†™ä½œæ¦‚è§ˆå¤±è´¥:', error);
      throw error;
    }
  }

  private async adjustUserStyleProfile(feedback: FeedbackRecord): Promise<void> {
    const currentProfile = await db.userStyleProfile.findUnique({
      where: {
        username_contentType: {
          username: feedback.username,
          contentType: feedback.contentType
        }
      }
    });

    if (!currentProfile) {
      throw new Error(`ç”¨æˆ· ${feedback.username} çš„ ${feedback.contentType} ç±»å‹é£æ ¼æ¡£æ¡ˆä¸å­˜åœ¨`);
    }

    const adjustmentPrompt = `
è¯·åŸºäºç”¨æˆ·åé¦ˆè°ƒæ•´"${feedback.contentType}"ç±»å‹çš„å…·ä½“é£æ ¼æ¡£æ¡ˆã€‚

å½“å‰é£æ ¼æ¡£æ¡ˆï¼š
- ç­¾åè¯æ±‡ï¼š${currentProfile.signatureWords || 'æœªè®¾ç½®'}
- å¸¸ç”¨å¼€å¤´ï¼š${currentProfile.commonOpenings || 'æœªè®¾ç½®'}
- å¸¸ç”¨ç»“å°¾ï¼š${currentProfile.commonClosings || 'æœªè®¾ç½®'}
- è¯­è°ƒç‰¹å¾ï¼š${currentProfile.toneFeatures || 'æœªè®¾ç½®'}
- å¹³å‡å¥é•¿ï¼š${currentProfile.avgSentenceLength || 'æœªè®¾ç½®'}
- å¥å‹åˆ†å¸ƒï¼š${currentProfile.sentenceTypeDist || 'æœªè®¾ç½®'}
- æ ‡ç‚¹æ¨¡å¼ï¼š${currentProfile.punctuationPattern || 'æœªè®¾ç½®'}

ç”¨æˆ·åé¦ˆä¿¡æ¯ï¼š
- è¯„åˆ†ï¼š${feedback.rating}/5
- åé¦ˆæ ‡ç­¾ï¼š${feedback.feedbackTags}
- å…·ä½“é—®é¢˜ï¼š${feedback.feedbackText}
- ç”Ÿæˆé˜¶æ®µï¼š${feedback.stage}

åé¦ˆé’ˆå¯¹çš„å†…å®¹ç¤ºä¾‹ï¼š
${feedback.targetContent.substring(0, 500)}...

è¯·é’ˆå¯¹å…·ä½“åé¦ˆè¿›è¡Œç²¾å‡†è°ƒæ•´ï¼š

1. å¦‚æœåé¦ˆ"å¤ªä¹¦é¢åŒ–"ï¼š
   - è°ƒæ•´ signatureWordsï¼Œç§»é™¤æ­£å¼è¯æ±‡ï¼Œå¢åŠ å£è¯­åŒ–è¡¨è¾¾
   - è°ƒæ•´ toneFeaturesï¼Œå¢åŠ éšæ„ã€äº²å’Œçš„ç‰¹å¾

2. å¦‚æœåé¦ˆå¼€å¤´/ç»“å°¾é—®é¢˜ï¼š
   - è°ƒæ•´ commonOpenings/commonClosingsï¼Œæä¾›æ›´è‡ªç„¶çš„å¼€å¤´ç»“å°¾æ¨¡å¼

3. å¦‚æœåé¦ˆè¯­è°ƒé—®é¢˜ï¼š
   - è°ƒæ•´ toneFeaturesï¼Œæ ¹æ®åé¦ˆä¿®æ­£è¯­è°ƒç‰¹å¾åˆ†å¸ƒ

4. å¦‚æœåé¦ˆå¥å¼é—®é¢˜ï¼š
   - è°ƒæ•´ avgSentenceLength å’Œ sentenceTypeDist

è¿”å›è°ƒæ•´å»ºè®®çš„JSONæ ¼å¼ï¼š
{
  "adjustments": {
    "signatureWords": "è°ƒæ•´åçš„ç­¾åè¯æ±‡JSONå­—ç¬¦ä¸²æˆ–null",
    "commonOpenings": "è°ƒæ•´åçš„å¼€å¤´æ¨¡å¼JSONå­—ç¬¦ä¸²æˆ–null",
    "commonClosings": "è°ƒæ•´åçš„ç»“å°¾æ¨¡å¼JSONå­—ç¬¦ä¸²æˆ–null",
    "toneFeatures": "è°ƒæ•´åçš„è¯­è°ƒç‰¹å¾JSONå­—ç¬¦ä¸²æˆ–null",
    "avgSentenceLength": è°ƒæ•´åçš„å¹³å‡å¥é•¿æ•°å€¼æˆ–null,
    "sentenceTypeDist": "è°ƒæ•´åçš„å¥å‹åˆ†å¸ƒJSONå­—ç¬¦ä¸²æˆ–null"
  },
  "reasoning": "è¯¦ç»†çš„è°ƒæ•´ç†ç”±å’Œè¯´æ˜"
}

æ³¨æ„ï¼šåªè¿”å›éœ€è¦è°ƒæ•´çš„å­—æ®µï¼Œä¸éœ€è¦è°ƒæ•´çš„å­—æ®µè®¾ä¸ºnullã€‚`;

    try {
      const config = await WritingAssistantConfigLoader.getAnalysisConfig();
      const aiService = AIServiceFactory.createService({
        provider: config.provider,
        model: config.model,
        apiKey: config.apiKey,
        baseURL: config.baseURL
      });

      const adjustmentResultStr = await aiService.generateText(adjustmentPrompt);
      const adjustmentResult = JSON.parse(adjustmentResultStr);

      // æ„å»ºæ›´æ–°æ•°æ®
      const updateData: any = {
        lastAnalyzedAt: new Date()
      };

      Object.entries(adjustmentResult.adjustments).forEach(([key, value]) => {
        if (value !== null) {
          updateData[key] = value;
        }
      });

      // æ›´æ–°æ•°æ®åº“
      await db.userStyleProfile.update({
        where: {
          username_contentType: {
            username: feedback.username,
            contentType: feedback.contentType
          }
        },
        data: updateData
      });

      console.log(`ç”¨æˆ· ${feedback.username} çš„ ${feedback.contentType} ç±»å‹é£æ ¼æ¡£æ¡ˆå·²æ ¹æ®åé¦ˆè°ƒæ•´`);
      console.log(`è°ƒæ•´ç†ç”±: ${adjustmentResult.reasoning}`);

    } catch (error) {
      console.error('è°ƒæ•´ç±»å‹åŒ–é£æ ¼æ¡£æ¡ˆå¤±è´¥:', error);
      throw error;
    }
  }

  private async analyzeFeedbackPattern(feedback: FeedbackRecord): Promise<void> {
    // è§£æåé¦ˆæ ‡ç­¾ï¼Œæ›´æ–°é—®é¢˜æ¨¡å¼ç»Ÿè®¡
    const tags = JSON.parse(feedback.feedbackTags || '[]');

    for (const tag of tags) {
      await db.feedbackPattern.upsert({
        where: {
          username_contentType_pattern: {
            username: feedback.username,
            contentType: feedback.contentType,
            pattern: tag
          }
        },
        update: {
          frequency: { increment: 1 },
          lastOccurred: new Date(),
          feedbackType: feedback.rating <= 2 ? 'negative' : feedback.rating >= 4 ? 'positive' : 'neutral'
        },
        create: {
          username: feedback.username,
          contentType: feedback.contentType,
          pattern: tag,
          frequency: 1,
          lastOccurred: new Date(),
          feedbackType: feedback.rating <= 2 ? 'negative' : feedback.rating >= 4 ? 'positive' : 'neutral'
        }
      });
    }
  }
}
```

### 2.3 APIæ¥å£è®¾è®¡

#### A. åé¦ˆæäº¤æ¥å£
```typescript
// /api/feedback/submit
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const {
      resultId,
      stage = 'final',
      rating,
      feedbackText,
      feedbackTags = [],
      adjustmentTarget = 'profile'
    } = body;

    // è·å–ç”Ÿæˆç»“æœä¿¡æ¯
    const result = await db.articleGenerationResult.findUnique({
      where: { id: resultId },
      include: { task: true }
    });

    if (!result) {
      return NextResponse.json({ error: 'Generation result not found' }, { status: 404 });
    }

    // ç¡®å®šç›®æ ‡å†…å®¹
    let targetContent = '';
    switch (stage) {
      case 'outline':
        targetContent = result.outlineContent || '';
        break;
      case 'draft':
        targetContent = result.draftContent || '';
        break;
      case 'final':
        targetContent = result.finalContent || result.generatedContent;
        break;
    }

    // ä¿å­˜åé¦ˆå¹¶æ›´æ–°ç»“æœè®°å½•
    await db.articleGenerationResult.update({
      where: { id: resultId },
      data: {
        userRating: rating,
        userFeedback: feedbackText,
        feedbackTags: JSON.stringify(feedbackTags),
        adjustmentTarget,
        isImproved: false
      }
    });

    // å¼‚æ­¥å¤„ç†åé¦ˆè°ƒæ•´
    const feedbackData = {
      resultId,
      username: result.task.username || '',
      contentType: result.task.contentType || '',
      stage,
      rating,
      feedbackText,
      feedbackTags: JSON.stringify(feedbackTags),
      adjustmentTarget,
      targetContent
    };

    // å¯åŠ¨å¼‚æ­¥å¤„ç†
    processFeedbackAdjustment(feedbackData).catch(console.error);

    return NextResponse.json({
      success: true,
      message: 'åé¦ˆå·²æäº¤ï¼Œç³»ç»Ÿæ­£åœ¨å¤„ç†è°ƒæ•´...'
    });

  } catch (error) {
    console.error('æäº¤åé¦ˆå¤±è´¥:', error);
    return NextResponse.json(
      { error: 'Failed to submit feedback' },
      { status: 500 }
    );
  }
}

async function processFeedbackAdjustment(feedbackData: any) {
  const adjustmentService = new FeedbackAdjustmentService();
  await adjustmentService.processFeedback(feedbackData);
}
```

#### B. ç”ŸæˆçŠ¶æ€æŸ¥è¯¢æ¥å£
```typescript
// /api/generation/status/:taskId
export async function GET(request: NextRequest, { params }: { params: { taskId: string } }) {
  try {
    const result = await db.articleGenerationResult.findUnique({
      where: { taskId: params.taskId },
      include: { task: true }
    });

    if (!result) {
      return NextResponse.json({ error: 'Result not found' }, { status: 404 });
    }

    const stageStatus = {
      outline: !!result.outlineContent,
      draft: !!result.draftContent,
      final: !!result.finalContent || !!result.generatedContent
    };

    return NextResponse.json({
      success: true,
      data: {
        taskId: params.taskId,
        status: result.task.status,
        stages: stageStatus,
        result: {
          outline: result.outlineContent,
          draft: result.draftContent,
          final: result.finalContent || result.generatedContent,
          selfReviewNotes: result.selfReviewNotes,
          feedback: {
            rating: result.userRating,
            text: result.userFeedback,
            tags: result.feedbackTags ? JSON.parse(result.feedbackTags) : [],
            adjustmentTarget: result.adjustmentTarget,
            isImproved: result.isImproved
          }
        }
      }
    });

  } catch (error) {
    console.error('æŸ¥è¯¢ç”ŸæˆçŠ¶æ€å¤±è´¥:', error);
    return NextResponse.json(
      { error: 'Failed to fetch generation status' },
      { status: 500 }
    );
  }
}
```

## 3. æ ¸å¿ƒäººæ ¼æå–ä¼˜åŒ–

### 3.1 å¤šç»´åº¦äººæ ¼çŸ©é˜µ
```typescript
interface PersonalityMatrix {
  cognitive: {
    rational_emotional: number; // -1åˆ°1ï¼Œ-1åæ„Ÿæ€§ï¼Œ1åç†æ€§
    abstract_concrete: number; // -1å…·ä½“ï¼Œ1æŠ½è±¡
    critical_accepting: number; // -1åŒ…å®¹ï¼Œ1æ‰¹åˆ¤
  };
  emotional: {
    optimistic_cautious: number; // -1è°¨æ…ï¼Œ1ä¹è§‚
    humorous_serious: number; // -1ä¸¥è‚ƒï¼Œ1å¹½é»˜
    warm_authoritative: number; // -1æƒå¨ï¼Œ1äº²å’Œ
  };
  expression: {
    concise_detailed: number; // -1ç®€æ´ï¼Œ1è¯¦å°½
    direct_tactful: number; // -1å§”å©‰ï¼Œ1ç›´æ¥
    formal_casual: number; // -1éšæ„ï¼Œ1æ­£å¼
  };
  values: {
    innovative_traditional: number; // -1ä¼ ç»Ÿï¼Œ1åˆ›æ–°
    individual_collective: number; // -1é›†ä½“ï¼Œ1ä¸ªäºº
    process_result: number; // -1è¿‡ç¨‹ï¼Œ1ç»“æœ
  };
}

async function extractPersonalityMatrix(username: string): Promise<PersonalityMatrix> {
  const prompt = `åŸºäºç”¨æˆ·çš„å†™ä½œæ ·æœ¬ï¼Œåˆ†æå…¶æ ¸å¿ƒäººæ ¼ç‰¹å¾ï¼š

ç”¨æˆ·å†™ä½œæ ·æœ¬ï¼š
${await getUserWritingSamples(username)}

è¯·ä»ä»¥ä¸‹4ä¸ªç»´åº¦åˆ†æç”¨æˆ·çš„äººæ ¼ç‰¹å¾ï¼Œæ¯ä¸ªç»´åº¦åŒ…å«3ä¸ªå­ç»´åº¦ï¼Œç”¨-1åˆ°1çš„æ•°å€¼è¡¨ç¤ºå€¾å‘ï¼š

1. è®¤çŸ¥ç»´åº¦ï¼š
   - rational_emotional: ç†æ€§(-1æ„Ÿæ€§ï¼Œ1ç†æ€§)
   - abstract_concrete: æŠ½è±¡(-1å…·ä½“ï¼Œ1æŠ½è±¡)
   - critical_accepting: æ‰¹åˆ¤(-1åŒ…å®¹ï¼Œ1æ‰¹åˆ¤)

2. æƒ…æ„Ÿç»´åº¦ï¼š
   - optimistic_cautious: ä¹è§‚(-1è°¨æ…ï¼Œ1ä¹è§‚)
   - humorous_serious: å¹½é»˜(-1ä¸¥è‚ƒï¼Œ1å¹½é»˜)
   - warm_authoritative: äº²å’Œ(-1æƒå¨ï¼Œ1äº²å’Œ)

3. è¡¨è¾¾ç»´åº¦ï¼š
   - concise_detailed: è¯¦å°½(-1ç®€æ´ï¼Œ1è¯¦å°½)
   - direct_tactful: ç›´æ¥(-1å§”å©‰ï¼Œ1ç›´æ¥)
   - formal_casual: æ­£å¼(-1éšæ„ï¼Œ1æ­£å¼)

4. ä»·å€¼ç»´åº¦ï¼š
   - innovative_traditional: åˆ›æ–°(-1ä¼ ç»Ÿï¼Œ1åˆ›æ–°)
   - individual_collective: ä¸ªäºº(-1é›†ä½“ï¼Œ1ä¸ªäºº)
   - process_result: ç»“æœ(-1è¿‡ç¨‹ï¼Œ1ç»“æœ)

è¿”å›JSONæ ¼å¼çš„PersonalityMatrixå¯¹è±¡ã€‚`;

  const result = await callLLM(prompt);
  return JSON.parse(result);
}
```

### 3.2 åŠ¨æ€äººæ ¼æƒé‡è°ƒæ•´
```typescript
function getPersonalityWeights(contentType: string): Partial<PersonalityMatrix> {
  const weights: Record<string, Partial<PersonalityMatrix>> = {
    'ç§‘æ™®': {
      cognitive: { rational_emotional: 0.8, abstract_concrete: 0.6 },
      expression: { concise_detailed: 0.7, formal_casual: 0.4 }
    },
    'æç¬‘': {
      emotional: { humorous_serious: 0.9, warm_authoritative: 0.7 },
      expression: { formal_casual: -0.6, direct_tactful: 0.5 }
    },
    'æ—¶äº‹è¯„è®º': {
      cognitive: { critical_accepting: 0.8, rational_emotional: 0.6 },
      expression: { direct_tactful: 0.7 }
    },
    'è§‚ç‚¹è¡¨è¾¾': {
      cognitive: { critical_accepting: 0.6 },
      values: { individual_collective: 0.5 }
    }
  };

  return weights[contentType] || {};
}

function applyPersonalityWeights(basePersonality: PersonalityMatrix, contentType: string): PersonalityMatrix {
  const weights = getPersonalityWeights(contentType);
  const adjusted = { ...basePersonality };

  // åº”ç”¨æƒé‡è°ƒæ•´
  Object.entries(weights).forEach(([dimension, dimWeights]) => {
    Object.entries(dimWeights).forEach(([trait, weight]) => {
      if (adjusted[dimension] && adjusted[dimension][trait] !== undefined) {
        // å‘æƒé‡æ–¹å‘è°ƒæ•´30%
        const current = adjusted[dimension][trait];
        const target = weight > 0 ? 1 : -1;
        adjusted[dimension][trait] = current + (target - current) * 0.3;
      }
    });
  });

  return adjusted;
}
```

## 4. æç¤ºè¯è´¨é‡æ·±åº¦ä¼˜åŒ–

### 4.1 åˆ†å±‚æç¤ºè¯æ¶æ„
```typescript
interface LayeredPrompt {
  corePersonality: string;     // æ ¸å¿ƒäººæ ¼å±‚
  contentTypeStyle: string;    // å†…å®¹ç±»å‹å±‚
  contextualAdjustment: string; // å…·ä½“åœºæ™¯å±‚
  feedbackCorrection: string;   // åé¦ˆä¿®æ­£å±‚
}

async function buildLayeredPrompt(task: ArticleGenerationTask, stage: 'outline' | 'draft' | 'final'): Promise<string> {
  const layers: LayeredPrompt = {
    corePersonality: await buildCorePersonalityPrompt(task.username),
    contentTypeStyle: await buildContentTypePrompt(task.username, task.contentType),
    contextualAdjustment: await buildContextualPrompt(task),
    feedbackCorrection: await buildFeedbackCorrectionPrompt(task.username, task.contentType)
  };

  let prompt = `è¯·ä¸ºä»¥ä¸‹ä¸»é¢˜æ’°å†™${stage === 'outline' ? 'å¤§çº²' : stage === 'draft' ? 'åˆç¨¿' : 'æœ€ç»ˆå†…å®¹'}ï¼š

ä¸»é¢˜ï¼š${task.topic}
å¹³å°ï¼š${task.platform.name}
${task.platform.wordCount ? `å­—æ•°è¦æ±‚ï¼š${task.platform.wordCount}` : ''}`;

  // æ ¸å¿ƒäººæ ¼å±‚
  if (layers.corePersonality) {
    prompt += `\n\nã€æ ¸å¿ƒå†™ä½œäººæ ¼ã€‘\n${layers.corePersonality}`;
  }

  // å†…å®¹ç±»å‹å±‚
  if (layers.contentTypeStyle) {
    prompt += `\n\nã€${task.contentType}ç±»å‹ä¸“å±é£æ ¼ã€‘\n${layers.contentTypeStyle}`;
  }

  // å…·ä½“åœºæ™¯å±‚
  if (layers.contextualAdjustment) {
    prompt += `\n\nã€åœºæ™¯åŒ–è°ƒæ•´ã€‘\n${layers.contextualAdjustment}`;
  }

  // åé¦ˆä¿®æ­£å±‚
  if (layers.feedbackCorrection) {
    prompt += `\n\nã€é‡è¦åé¦ˆçº æ­£ã€‘\n${layers.feedbackCorrection}`;
  }

  // é˜¶æ®µç‰¹å®šè¦æ±‚
  prompt += await buildStageSpecificRequirements(stage, task);

  return prompt;
}

async function buildFeedbackCorrectionPrompt(username: string, contentType: string): Promise<string> {
  // è·å–ç”¨æˆ·æœ€è¿‘çš„è´Ÿé¢åé¦ˆæ¨¡å¼
  const negativePatterns = await db.feedbackPattern.findMany({
    where: {
      username,
      contentType,
      feedbackType: 'negative',
      isResolved: false
    },
    orderBy: { frequency: 'desc' },
    take: 5
  });

  if (negativePatterns.length === 0) return '';

  let correctionPrompt = 'è¯·ç‰¹åˆ«æ³¨æ„é¿å…ä»¥ä¸‹ç”¨æˆ·å·²åé¦ˆçš„é—®é¢˜ï¼š\n';

  negativePatterns.forEach(pattern => {
    correctionPrompt += `- ${pattern.pattern}ï¼ˆå·²å‡ºç°${pattern.frequency}æ¬¡ï¼‰\n`;
  });

  // æ·»åŠ å…·ä½“çš„è§£å†³ç­–ç•¥
  const strategies = getFeedbackStrategies(negativePatterns.map(p => p.pattern));
  if (strategies.length > 0) {
    correctionPrompt += '\nè§£å†³ç­–ç•¥ï¼š\n';
    strategies.forEach(strategy => {
      correctionPrompt += `- ${strategy}\n`;
    });
  }

  return correctionPrompt;
}

function getFeedbackStrategies(patterns: string[]): string[] {
  const strategies: string[] = [];

  if (patterns.some(p => p.includes('ä¹¦é¢åŒ–'))) {
    strategies.push('å¤šä½¿ç”¨"è¿™ä¸ª"ã€"é‚£ä¸ª"ç­‰æŒ‡ä»£è¯');
    strategies.push('ä½¿ç”¨"æŒº"ã€"è›®"ç­‰ç¨‹åº¦å‰¯è¯');
    strategies.push('é‡‡ç”¨ç–‘é—®å¥å’Œæ„Ÿå¹å¥å¢åŠ äº’åŠ¨æ„Ÿ');
    strategies.push('é¿å…è¿‡äºæ­£å¼çš„ä¹¦é¢è¡¨è¾¾');
  }

  if (patterns.some(p => p.includes('å¼€å¤´çªå…€'))) {
    strategies.push('ä½¿ç”¨è‡ªç„¶çš„è¿‡æ¸¡å’Œå¼•å…¥');
    strategies.push('ä»¥é—®é¢˜æˆ–åœºæ™¯å¼€å¤´å»ºç«‹è¿æ¥');
  }

  if (patterns.some(p => p.includes('ç¼ºä¹äº’åŠ¨æ„Ÿ'))) {
    strategies.push('å¤šä½¿ç”¨ç¬¬äºŒäººç§°"ä½ "');
    strategies.push('å¢åŠ ç–‘é—®å¥å’Œåé—®å¥');
    strategies.push('ä½¿ç”¨"å’±ä»¬"ã€"å¤§å®¶"ç­‰åŒ…å®¹æ€§è¯æ±‡');
  }

  return strategies;
}
```

## 5. åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### æ¿å—1ï¼šåŸºç¡€æ¶æ„æ­å»ºï¼ˆ2-3å¤©ï¼‰
**ç›®æ ‡**ï¼šä¸ºæ–°åŠŸèƒ½æä¾›æ•°æ®å’ŒæœåŠ¡åŸºç¡€

#### ç¬¬1å¤©ï¼šæ•°æ®åº“ç»“æ„å‡çº§
- **ä¸Šåˆ**ï¼š
  - æ‰©å±• `ArticleGenerationResult` è¡¨ï¼Œæ·»åŠ ä¸‰é˜¶æ®µå­—æ®µ
  - æ–°å¢ `FeedbackPattern` è¡¨
  - æ›´æ–° Prisma schema æ–‡ä»¶
- **ä¸‹åˆ**ï¼š
  - è¿è¡Œæ•°æ®åº“è¿ç§»å‘½ä»¤
  - éªŒè¯æ•°æ®åº“ç»“æ„æ­£ç¡®æ€§
  - æ›´æ–°ç›¸å…³ TypeScript ç±»å‹å®šä¹‰

#### ç¬¬2å¤©ï¼šå†…å®¹ç±»å‹å¤§çº²æ¨¡æ¿ç³»ç»Ÿ
- **ä¸Šåˆ**ï¼š
  - å®ç° `OUTLINE_TEMPLATES` é…ç½®
  - åˆ›å»º `ContentTypeOutlineGenerator` ç±»
  - å®ç° `OutlineValidator` éªŒè¯å™¨
- **ä¸‹åˆ**ï¼š
  - å•å…ƒæµ‹è¯•å„ä¸ªå†…å®¹ç±»å‹çš„å¤§çº²ç”Ÿæˆ
  - éªŒè¯æ¨¡æ¿é€»è¾‘çš„æ­£ç¡®æ€§

#### ç¬¬3å¤©ï¼šæ ¸å¿ƒæœåŠ¡é‡æ„
- **ä¸Šåˆ**ï¼š
  - é‡æ„ `processArticleGeneration` å‡½æ•°æ”¯æŒä¸‰é˜¶æ®µ
  - å®ç°é˜¶æ®µçŠ¶æ€ç®¡ç†å’Œæ•°æ®ä¿å­˜
- **ä¸‹åˆ**ï¼š
  - é›†æˆå†…å®¹ç±»å‹åŒ–å¤§çº²ç”Ÿæˆ
  - æµ‹è¯•æ•´ä¸ªä¸‰é˜¶æ®µç”Ÿæˆæµç¨‹

**é‡Œç¨‹ç¢‘æ£€æŸ¥**ï¼šèƒ½å¤Ÿç”Ÿæˆç±»å‹åŒ–å¤§çº²å¹¶ä¿å­˜åˆ°æ•°æ®åº“

---

### æ¿å—2ï¼šä¸‰é˜¶æ®µç”Ÿæˆæ ¸å¿ƒï¼ˆ3-4å¤©ï¼‰
**ç›®æ ‡**ï¼šå®Œæ•´å®ç°å¤§çº²â†’åˆç¨¿â†’è‡ªæŸ¥çš„ä¸‰é˜¶æ®µç”Ÿæˆ

#### ç¬¬4å¤©ï¼šé˜¶æ®µ1ä¼˜åŒ–ï¼ˆå¤§çº²ç”Ÿæˆï¼‰
- **ä¸Šåˆ**ï¼š
  - å®Œå–„ `generateOutline` å‡½æ•°
  - é›†æˆä¸ªæ€§åŒ–é£æ ¼æç¤ºè¯
  - æ·»åŠ å‚è€ƒæ–‡ç« å’Œå†…å®¹ç»“æ„æ”¯æŒ
- **ä¸‹åˆ**ï¼š
  - æµ‹è¯•ä¸åŒå†…å®¹ç±»å‹çš„å¤§çº²è´¨é‡
  - ä¼˜åŒ–æç¤ºè¯å’ŒéªŒè¯é€»è¾‘

#### ç¬¬5å¤©ï¼šé˜¶æ®µ2å®ç°ï¼ˆåˆç¨¿æ‰©å±•ï¼‰
- **ä¸Šåˆ**ï¼š
  - å®ç° `generateDraft` å‡½æ•°
  - åŸºäºå¤§çº²çš„å†…å®¹æ‰©å±•é€»è¾‘
  - é›†æˆç”¨æˆ·é£æ ¼æ¡£æ¡ˆ
- **ä¸‹åˆ**ï¼š
  - æµ‹è¯•å¤§çº²åˆ°åˆç¨¿çš„è½¬æ¢è´¨é‡
  - ä¼˜åŒ–æ‰©å±•æç¤ºè¯

#### ç¬¬6å¤©ï¼šé˜¶æ®µ3å®ç°ï¼ˆè‡ªæŸ¥ä¼˜åŒ–ï¼‰
- **ä¸Šåˆ**ï¼š
  - å®ç° `selfReviewAndOptimize` å‡½æ•°
  - å¤šç»´åº¦å†…å®¹è´¨é‡æ£€æŸ¥
  - è‡ªåŠ¨ä¼˜åŒ–å’Œæ”¹è¿›é€»è¾‘
- **ä¸‹åˆ**ï¼š
  - æµ‹è¯•è‡ªæŸ¥åŠŸèƒ½çš„æ•ˆæœ
  - ä¼˜åŒ–æ£€æŸ¥æ ‡å‡†å’Œæ”¹è¿›ç­–ç•¥

#### ç¬¬7å¤©ï¼šæµç¨‹é›†æˆä¸ä¼˜åŒ–
- **ä¸Šåˆ**ï¼š
  - å®Œå–„ä¸‰é˜¶æ®µä¸»æµç¨‹
  - æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
  - æ€§èƒ½ä¼˜åŒ–å’Œtokenç»Ÿè®¡
- **ä¸‹åˆ**ï¼š
  - ç«¯åˆ°ç«¯æµ‹è¯•å®Œæ•´ç”Ÿæˆæµç¨‹
  - ä¿®å¤å‘ç°çš„é—®é¢˜

**é‡Œç¨‹ç¢‘æ£€æŸ¥**ï¼šèƒ½å¤Ÿå®Œæ•´æ‰§è¡Œä¸‰é˜¶æ®µç”Ÿæˆå¹¶äº§å‡ºé«˜è´¨é‡å†…å®¹

---

### æ¿å—3ï¼šç”¨æˆ·åé¦ˆç³»ç»Ÿï¼ˆ2-3å¤©ï¼‰
**ç›®æ ‡**ï¼šå®ç°ç”¨æˆ·åé¦ˆæ”¶é›†å’Œæ™ºèƒ½é£æ ¼è°ƒæ•´

#### ç¬¬8å¤©ï¼šåé¦ˆå¤„ç†æœåŠ¡
- **ä¸Šåˆ**ï¼š
  - å®ç° `FeedbackAdjustmentService` æ ¸å¿ƒç±»
  - åé¦ˆæ¨¡å¼åˆ†æå’Œç»Ÿè®¡
  - LLMé©±åŠ¨çš„é£æ ¼è°ƒæ•´é€»è¾‘
- **ä¸‹åˆ**ï¼š
  - å®ç°åŒå±‚è°ƒæ•´æœºåˆ¶ï¼ˆOverview vs Profileï¼‰
  - æµ‹è¯•åé¦ˆå¤„ç†çš„å‡†ç¡®æ€§

#### ç¬¬9å¤©ï¼šåé¦ˆAPIæ¥å£
- **ä¸Šåˆ**ï¼š
  - åˆ›å»ºåé¦ˆæäº¤ API (`/api/feedback/submit`)
  - ç”ŸæˆçŠ¶æ€æŸ¥è¯¢ API (`/api/generation/status/:taskId`)
  - å¼‚æ­¥åé¦ˆå¤„ç†é˜Ÿåˆ—
- **ä¸‹åˆ**ï¼š
  - APIæµ‹è¯•å’Œé”™è¯¯å¤„ç†
  - ä¸ç°æœ‰æ–‡ç« ç”Ÿæˆæµç¨‹é›†æˆ

#### ç¬¬10å¤©ï¼šæ™ºèƒ½æ¨èç³»ç»Ÿ
- **ä¸Šåˆ**ï¼š
  - å®ç°åé¦ˆç­–ç•¥æ˜ å°„ (`getFeedbackStrategies`)
  - æ™ºèƒ½æ¨èè°ƒæ•´ç›®æ ‡é€»è¾‘
  - è´Ÿé¢æ¨¡å¼è¯†åˆ«å’Œé¢„é˜²
- **ä¸‹åˆ**ï¼š
  - æµ‹è¯•æ¨èç³»ç»Ÿçš„å‡†ç¡®æ€§
  - ä¼˜åŒ–æ¨èç®—æ³•

**é‡Œç¨‹ç¢‘æ£€æŸ¥**ï¼šç”¨æˆ·åé¦ˆèƒ½å¤Ÿæ­£ç¡®è°ƒæ•´å†™ä½œé£æ ¼

---

### æ¿å—4ï¼šå‰ç«¯äº¤äº’ç•Œé¢ï¼ˆ2-3å¤©ï¼‰
**ç›®æ ‡**ï¼šæä¾›ç”¨æˆ·å‹å¥½çš„ä¸‰é˜¶æ®µå†…å®¹å±•ç¤ºå’Œåé¦ˆç•Œé¢

#### ç¬¬11å¤©ï¼šä¸‰é˜¶æ®µå±•ç¤ºç»„ä»¶
- **ä¸Šåˆ**ï¼š
  - å®ç° `GenerationStagesViewer` ç»„ä»¶
  - é˜¶æ®µåˆ‡æ¢å’Œå†…å®¹å±•ç¤º
  - ç”Ÿæˆè¿›åº¦æŒ‡ç¤ºå™¨
- **ä¸‹åˆ**ï¼š
  - è‡ªæŸ¥ä¼˜åŒ–è¯´æ˜å±•ç¤º
  - å“åº”å¼è®¾è®¡å’Œæ ·å¼ä¼˜åŒ–

#### ç¬¬12å¤©ï¼šåé¦ˆæ”¶é›†ç»„ä»¶
- **ä¸Šåˆ**ï¼š
  - å®ç° `FeedbackForm` ç»„ä»¶
  - è¯„åˆ†ã€æ ‡ç­¾å’Œæ–‡æœ¬åé¦ˆ
  - è°ƒæ•´ç›®æ ‡é€‰æ‹©ç•Œé¢
- **ä¸‹åˆ**ï¼š
  - æ™ºèƒ½æ¨èæç¤º
  - è¡¨å•éªŒè¯å’Œæäº¤é€»è¾‘

#### ç¬¬13å¤©ï¼šç•Œé¢é›†æˆä¸ä¼˜åŒ–
- **ä¸Šåˆ**ï¼š
  - é›†æˆåˆ°ç°æœ‰çš„æ–‡ç« ç”Ÿæˆé¡µé¢
  - æ·»åŠ åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
  - ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **ä¸‹åˆ**ï¼š
  - ç§»åŠ¨ç«¯é€‚é…
  - äº¤äº’ç»†èŠ‚å®Œå–„

**é‡Œç¨‹ç¢‘æ£€æŸ¥**ï¼šç”¨æˆ·å¯ä»¥ç›´è§‚åœ°æŸ¥çœ‹ä¸‰é˜¶æ®µå†…å®¹å¹¶æäº¤åé¦ˆ

---

### æ¿å—5ï¼šæµ‹è¯•ä¸éƒ¨ç½²ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰
**ç›®æ ‡**ï¼šç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½

#### ç¬¬14å¤©ï¼šç»¼åˆæµ‹è¯•
- **ä¸Šåˆ**ï¼š
  - ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•
  - ä¸åŒå†…å®¹ç±»å‹çš„ç”Ÿæˆæµ‹è¯•
  - åé¦ˆè°ƒæ•´æ•ˆæœéªŒè¯
- **ä¸‹åˆ**ï¼š
  - æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
  - å†…å­˜ä½¿ç”¨å’ŒLLMè°ƒç”¨ä¼˜åŒ–
  - å¹¶å‘å¤„ç†æµ‹è¯•

#### ç¬¬15å¤©ï¼šéƒ¨ç½²å‡†å¤‡ï¼ˆå¯é€‰ï¼‰
- **ä¸Šåˆ**ï¼š
  - ç”Ÿäº§ç¯å¢ƒé…ç½®æ£€æŸ¥
  - æ•°æ®åº“è¿ç§»è„šæœ¬å‡†å¤‡
  - ç›‘æ§å’Œæ—¥å¿—é…ç½®
- **ä¸‹åˆ**ï¼š
  - æ–‡æ¡£æ›´æ–°å’Œä½¿ç”¨è¯´æ˜
  - å¤‡ä»½å’Œå›æ»šæ–¹æ¡ˆ

**é‡Œç¨‹ç¢‘æ£€æŸ¥**ï¼šç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ

---

## å®æ–½ç­–ç•¥å»ºè®®

### **æ¸è¿›å¼æ¨è¿›**
1. **å…ˆæ ¸å¿ƒåæ‰©å±•**ï¼šä¼˜å…ˆå®ç°ä¸‰é˜¶æ®µç”Ÿæˆï¼Œå†æ·»åŠ åé¦ˆåŠŸèƒ½
2. **å…ˆåç«¯åå‰ç«¯**ï¼šç¡®ä¿æ•°æ®å’Œé€»è¾‘æ­£ç¡®åå†å¼€å‘ç•Œé¢
3. **å°æ­¥å¿«è·‘**ï¼šæ¯ä¸ªæ¿å—éƒ½æœ‰ç‹¬ç«‹çš„é‡Œç¨‹ç¢‘æ£€æŸ¥

### **é£é™©æ§åˆ¶**
1. **å‘ä¸‹å…¼å®¹**ï¼šç¡®ä¿æ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰çš„å•é˜¶æ®µç”Ÿæˆ
2. **åŠŸèƒ½å¼€å…³**ï¼šä½¿ç”¨é…ç½®å¼€å…³æ§åˆ¶æ–°åŠŸèƒ½çš„å¯ç”¨
3. **æ•°æ®å¤‡ä»½**ï¼šé‡è¦æ•°æ®åº“å˜æ›´å‰åšå¥½å¤‡ä»½

### **æµ‹è¯•ç­–ç•¥**
1. **å•å…ƒæµ‹è¯•**ï¼šæ¯ä¸ªæ ¸å¿ƒå‡½æ•°éƒ½æœ‰å¯¹åº”æµ‹è¯•
2. **é›†æˆæµ‹è¯•**ï¼šéªŒè¯å„ä¸ªæ¿å—çš„åä½œ
3. **ç”¨æˆ·æµ‹è¯•**ï¼šçœŸå®åœºæ™¯ä¸‹çš„ä½“éªŒéªŒè¯

### **æ€§èƒ½è€ƒè™‘**
1. **ç¼“å­˜ç­–ç•¥**ï¼šå¤§çº²æ¨¡æ¿å’Œç”¨æˆ·é£æ ¼æ•°æ®ç¼“å­˜
2. **å¼‚æ­¥å¤„ç†**ï¼šé•¿æ—¶é—´çš„LLMè°ƒç”¨ä½¿ç”¨åå°é˜Ÿåˆ—
3. **èµ„æºé™åˆ¶**ï¼šè®¾ç½®åˆç†çš„å¹¶å‘é™åˆ¶å’Œè¶…æ—¶æ—¶é—´

**æ€»è®¡ï¼š15å¤©å®Œæˆå…¨éƒ¨åŠŸèƒ½ï¼Œæœ€çŸ­å¯å‹ç¼©è‡³12å¤©**

## 6. å…³é”®æŠ€æœ¯è¦ç‚¹

### A. å¹¶å‘å¤„ç†
- ä¸‰é˜¶æ®µç”Ÿæˆä½¿ç”¨ä¸²è¡Œå¤„ç†ï¼Œç¡®ä¿é€»è¾‘ä¾èµ–
- åé¦ˆå¤„ç†ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡ç”¨æˆ·ç•Œé¢
- ä½¿ç”¨deduplicationManageré˜²æ­¢é‡å¤å¤„ç†

### B. é”™è¯¯æ¢å¤
- æ¯ä¸ªé˜¶æ®µç‹¬ç«‹ä¿å­˜ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- å¤±è´¥é˜¶æ®µå¯ä»¥é‡æ–°æ‰§è¡Œï¼Œä¸å½±å“å·²å®Œæˆé˜¶æ®µ
- æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’ŒçŠ¶æ€è¿½è¸ª

### C. æ€§èƒ½ä¼˜åŒ–
- LLMè°ƒç”¨ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- åé¦ˆæ¨¡å¼åˆ†æä½¿ç”¨æ‰¹é‡å¤„ç†
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å’Œç´¢å¼•è®¾è®¡

### D. æ‰©å±•æ€§è®¾è®¡
- æ”¯æŒæ–°å¢ç”Ÿæˆé˜¶æ®µ
- æ”¯æŒæ–°çš„åé¦ˆç±»å‹å’Œè°ƒæ•´ç›®æ ‡
- æ¨¡å—åŒ–çš„æœåŠ¡è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•


â€”â€”â€”â€”â€”â€”ç ”å‘è®¡åˆ’â€”â€”â€”â€”â€”â€”

å®æ–½è®¡åˆ’æ¦‚è§ˆ

  ğŸ—ï¸ æ¿å—1ï¼šåŸºç¡€æ¶æ„æ­å»ºï¼ˆ2-3å¤©ï¼‰

  - æ•°æ®åº“ç»“æ„å‡çº§ï¼šä¸‰é˜¶æ®µå­—æ®µã€åé¦ˆè¡¨
  - å†…å®¹ç±»å‹å¤§çº²æ¨¡æ¿ç³»ç»Ÿï¼š12ç§ç±»å‹çš„å®Œæ•´æ¨¡æ¿
  - æ ¸å¿ƒæœåŠ¡é‡æ„ï¼šæ”¯æŒä¸‰é˜¶æ®µçš„ç”Ÿæˆæµç¨‹

  âš™ï¸ æ¿å—2ï¼šä¸‰é˜¶æ®µç”Ÿæˆæ ¸å¿ƒï¼ˆ3-4å¤©ï¼‰

  - é˜¶æ®µ1ä¼˜åŒ–ï¼šç±»å‹åŒ–å¤§çº²ç”Ÿæˆ
  - é˜¶æ®µ2å®ç°ï¼šåŸºäºå¤§çº²çš„åˆç¨¿æ‰©å±•
  - é˜¶æ®µ3å®ç°ï¼šè‡ªæŸ¥ä¼˜åŒ–å’Œè´¨é‡æå‡
  - æµç¨‹é›†æˆï¼šå®Œæ•´çš„ç«¯åˆ°ç«¯ç”Ÿæˆ

  ğŸ”„ æ¿å—3ï¼šç”¨æˆ·åé¦ˆç³»ç»Ÿï¼ˆ2-3å¤©ï¼‰

  - åé¦ˆå¤„ç†æœåŠ¡ï¼šLLMé©±åŠ¨çš„é£æ ¼è°ƒæ•´
  - åé¦ˆAPIæ¥å£ï¼šæäº¤å’ŒçŠ¶æ€æŸ¥è¯¢
  - æ™ºèƒ½æ¨èç³»ç»Ÿï¼šè‡ªåŠ¨æ¨èè°ƒæ•´ç›®æ ‡

  ğŸ¨ æ¿å—4ï¼šå‰ç«¯äº¤äº’ç•Œé¢ï¼ˆ2-3å¤©ï¼‰

  - ä¸‰é˜¶æ®µå±•ç¤ºç»„ä»¶ï¼šå¤§çº²/åˆç¨¿/æœ€ç»ˆç‰ˆåˆ‡æ¢
  - åé¦ˆæ”¶é›†ç»„ä»¶ï¼šè¯„åˆ†ã€æ ‡ç­¾ã€è°ƒæ•´ç›®æ ‡é€‰æ‹©
  - ç•Œé¢é›†æˆä¼˜åŒ–ï¼šç”¨æˆ·ä½“éªŒå’Œå“åº”å¼è®¾è®¡

  ğŸ§ª æ¿å—5ï¼šæµ‹è¯•ä¸éƒ¨ç½²ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰

  - ç»¼åˆæµ‹è¯•ï¼šåŠŸèƒ½ã€æ€§èƒ½ã€å¹¶å‘æµ‹è¯•
  - éƒ¨ç½²å‡†å¤‡ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®å’Œç›‘æ§

  å…³é”®ç‰¹ç‚¹

  ğŸ“ˆ æ¸è¿›å¼æ¨è¿›

  - æ¯ä¸ªæ¿å—éƒ½æœ‰ç‹¬ç«‹çš„é‡Œç¨‹ç¢‘æ£€æŸ¥
  - å…ˆæ ¸å¿ƒåæ‰©å±•ï¼šä¼˜å…ˆä¿è¯åŸºç¡€åŠŸèƒ½ç¨³å®š
  - å…ˆåç«¯åå‰ç«¯ï¼šç¡®ä¿æ•°æ®é€»è¾‘æ­£ç¡®

  ğŸ›¡ï¸ é£é™©æ§åˆ¶

  - å‘ä¸‹å…¼å®¹ï¼šä¸å½±å“ç°æœ‰å•é˜¶æ®µç”Ÿæˆ
  - åŠŸèƒ½å¼€å…³ï¼šé…ç½®æ§åˆ¶æ–°åŠŸèƒ½å¯ç”¨
  - æ•°æ®å¤‡ä»½ï¼šé‡è¦å˜æ›´å‰çš„å®‰å…¨ä¿éšœ

  âš¡ æ€§èƒ½è€ƒè™‘

  - ç¼“å­˜ç­–ç•¥ï¼šæ¨¡æ¿å’Œç”¨æˆ·æ•°æ®ç¼“å­˜
  - å¼‚æ­¥å¤„ç†ï¼šLLMè°ƒç”¨åå°é˜Ÿåˆ—
  - èµ„æºé™åˆ¶ï¼šåˆç†çš„å¹¶å‘å’Œè¶…æ—¶æ§åˆ¶